%%
%% This is file `hluatex-experimental.def',
%% This is an adapted version of hluatex.def
%% meant to test the use of the commands
%% from pdfresources.sty
%%

\ProvidesFile{hluatex-experimental.def}
  [2019/04/07 v0.2 %
  Hyperref driver for luaTeX]
\RequirePackage{xparse}

%%\Hy@VersionCheck{hluatex.def}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ExplSyntaxOn
%% messages, should later (with more drivers) go somewhere more generic ...
\prop_gput:Nnn \g_msg_module_name_prop { hyp }{ hyperref }
\msg_new:nnn
  {hyp}
  {missing-bookmark-package}
  { The~bookmark~package~is~required~for~this~hyperref~driver!}
%% I require the bookmark package to get rid of some of the bookmarks code.
\AtEndOfPackage{% so that we are later than KOMA ...
\AtBeginDocument
 {
  \ltx@ifpackageloaded{bookmark}
   {}
   {\msg_error:nn {hyp}{missing-bookmark-package}}
 }}

% booleans for the (some) option keys. As hyperref disables them it is okay to set them here, hypersetup
% can't interfere
%%% pdfa key:
\bool_new:N\l__hyp_pdfa_bool
\ifHy@pdfa
 \bool_set_true:N \l__hyp_pdfa_bool
\fi

%%% pdfversion
\bool_new:N\l__hyp_setpdfversion_bool
\ifHy@setpdfversion
 \bool_set_true:N \l__hyp_setpdfversion_bool
\fi


% this need sorting out later. pdf standards should be handled outside the driver.
% pdfa forces the flag /F 4 in some places.
\AtBeginDocument
{
  \bool_if:NT \l__hyp_pdfa_bool
  {
    \hook_put:nnnn
     { pdf }
     { link_begin_url_attr }
     { /F }{ 4 } %

    \hook_put:nnnn
     { pdf }
     { link_begin_link_attr }
     { /F } { 4 }

     \hook_put:nnnn
     { pdf }
     { link_begin_file_attr }
     { /F } { 4 }

     \hook_put:nnnn
     { pdf }
     { link_begin_menu_attr }
     { /F } { 4 }
   }
}
% variants of hyperref commands to get attributes in the prop
% these are (temporary) commands to fill various attributes (color, border style) in
% the hooks for links from the hyperref keys.
\clist_const:Nn \c__hyp_link_types_clist { url , file , run , link, menu }

\def\Hy@EXPsetpdfborder
 {
 \clist_map_inline:Nn \c__hyp_link_types_clist
   {
    \tl_if_empty:NTF \@pdfborder
     {
      \hook_remove:nnn { pdf } { link_begin_##1_attr } { /Border }
     }
     {
      \hook_put:nnnn
       { pdf }
       { link_begin_##1_attr }
       { /Border }
       { [\@pdfborder] }
     }
    \tl_if_empty:NTF \@pdfborderstyle
     {
      \hook_remove:nnn  { pdf }{ link_begin_##1_attr } { /BS }
     }
     {
      \hook_put:nnnn
      { pdf }
      { link_begin_##1_attr }
      { /BS }
      { <<\@pdfborderstyle>> }
     }
   }
 }

\def\Hy@EXPsetpdfhighlight
 {
  \clist_map_inline:nn \c__hyp_link_types_clist
   {
    \tl_if_empty:NTF \@pdfhighlight
     {
      \hook_remove:nnn { pdf } { link_begin_##1_attr }{ /H }
     }
     {
      \hook_put:nnnn
      { pdf }
      { link_begin_##1_attr }
      { /H }
      { \@pdfhighlight }
     }
  }
 }

\def\Hy@EXPsetbordercolor
  {
   \clist_map_inline:Nn \c__hyp_link_types_clist
   {
    \tl_if_exist:cTF { @##1bordercolor }
    {
     \hook_put:nnnn
      { pdf }
      { link_begin_##1_attr }
      { /C }
      { [\tl_use:c {@##1bordercolor}] }
    }
    {
     \hook_remove:nnn { pdf } { link_begin_##1_attr } { /C }
    }
   }
  }

% for now we are updating the attribute manually after \hypersetup
% some better method must be found
\NewDocumentCommand\hypupdateattribute { }
{
 \Hy@EXPsetpdfborder
 \Hy@EXPsetpdfhighlight
 \Hy@EXPsetbordercolor
}
\ExplSyntaxOff

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%only used in test if version can be set
\protected\def\pdflastannot      {\numexpr\pdffeedback lastannot\relax}
\protected\def\pdflastobj        {\numexpr\pdffeedback lastobj\relax}

\protected\def\pdfliteral        {\pdfextension literal}

\protected\edef\pdfpageattr            {\pdfvariable pageattr}

\protected\edef\pdfpageresources       {\pdfvariable pageresources}
\protected\edef\pdfpagesattr           {\pdfvariable pagesattr}


\protected\def\pdfstartlink      {\pdfextension startlink }
\protected\def\pdfendlink        {\pdfextension endlink\relax}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn
% catalog mapped to expl3 command
\pdf@ifdraftmode
 {
  \let\Hy@PutCatalog \use_none:n
 }
 {
  \let\Hy@PutCatalog \driver_pdf_catalog:n
 }
\ExplSyntaxOff


\ifHy@pdfpagelabels
  \def\HyPL@StorePageLabel#1{%
    \toks@\expandafter{\HyPL@Labels}%
    \xdef\HyPL@Labels{%
      \the\toks@
      \the\Hy@abspage<<#1>>%
    }%
  }%
  \RequirePackage{atveryend}[2009/12/07]%
  \AtVeryEndDocument{%
    \HyPL@SetPageLabels
  }%
\fi
%UF removed manual Hy@pstringdef definition, as \pdf@escapestring should be always defined
%if needed a kernel command should be provided for other drivers ...
  \def\Hy@pstringdef#1#2{%
    \begingroup
      \edef~{\string~}%
      \xdef\Hy@gtemp{\pdf@escapestring{#2}}%
    \endgroup
    \let#1\Hy@gtemp
  }%
\providecommand*{\XR@ext}{pdf}
\Hy@setbreaklinks{true}
\def\HyPat@ObjRef{%
  [0-9]*[1-9][0-9]* 0 R%
}


%\edef\Hy@pdfminorversion{\pdfvariable minorversion}%
%\edef\Hy@pdfmajorversion{\pdfvariable majorversion}%

\ExplSyntaxOn
\cs_set_eq:NN \Hy@pdfminorversion \driver_pdf_version_minor:
\cs_set_eq:NN \Hy@pdfmajorversion \driver_pdf_version_major:

  \ifHy@ocgcolorlinks
    \pdf_version_min_gset:n { 1.5 }
  \fi
\ExplSyntaxOff
% should this go into the drivers?
% or in the pdf level?
% set pdfversion / needs adaption to major version!!!
\ExplSyntaxOn
\bool_if:NT\l__hyp_setpdfversion_bool
 {
    \ifnum\Hy@pdfversion<5 %
        \ifHy@verbose
          \Hy@InfoNoLine{%
            PDF~object~streams~are~disabled,~because~they~are%
            \MessageBreak
            not~supported~in~requested~PDF~version %
            1.\Hy@pdfversion
          }%
        \fi
        \driver_pdf_objects_disable:
      %
    \fi
    \ifnum\Hy@pdfminorversion=\Hy@pdfversion\relax
    \else
      \let\Hy@temp\ltx@empty
      \def\Hy@temp@A#1#2{%
        \ifnum#1>\ltx@zero
          \edef\Hy@temp{%
            \Hy@temp
            \space\space
            \the#1\space #2%
            \ifnum#1=\ltx@one\else s\fi
            \MessageBreak
          }%
        \fi
      }%
      \Hy@temp@A\pdflastobj{PDF object}%
      \Hy@temp@A\lastsavedboxresourceindex{form XObject}%
      \Hy@temp@A\lastsavedimageresourceindex{image XObject}%
      \Hy@temp@A\pdflastannot{annotation}%
      \Hy@temp@A\driver_pdf_link_last_int:{link}%
      \ifx\Hy@temp\ltx@empty
       \int_compare:nNnTF { \Hy@pdfversion}  = {10 }
        { %pdf 2.0, temporary solution
          \pdf_version_gset:n {2.0}
        }
        {
          \pdf_version_gset:n{1.\Hy@pdfversion}
        }
      \else
        \let\Hy@temp@A\ltx@empty
        \ifnum\Hy@pdfversion=4 %
          \IfFileExists{pdf14.sty}{%
            \def\Hy@temp@A{%
              \MessageBreak
              Or \string\RequirePackage{pdf14} can be used%
              \MessageBreak
              before \string\documentclass\space as shortcut%
            }%
          }{}%
        \fi
        \Hy@WarningNoLine{%
          The PDF version number could not be set,\MessageBreak
          because some PDF objects are already written:%
          \MessageBreak
          \Hy@temp
          The version should be set as early as possible:%
          \MessageBreak
          \space\space
          \string\pdf_version_gset:n{\driver_pdf_version_major:.\driver_pdf_version_minor:}
          \ifnum\Hy@pdfversion<5 %
              \MessageBreak
              \space\space
              \string\driver_pdf_objects_disable:
          \fi
          \Hy@temp@A
        }%
      \fi
    \fi
    \PackageInfo{hyperref}{%
      pdf~version~set~to~\driver_pdf_version_major:.\driver_pdf_version_minor:\space
    }%
 }
  \edef\Hy@pdfversion
  { % this will need revision when pdf version stuff is better sorted
   \int_compare:nNnTF { \driver_pdf_version_minor: } = { 2 }
    { 10 }
    {\driver_pdf_version_minor:}
  }
 \ExplSyntaxOff
\Hy@DisableOption{pdfversion}%

\ExplSyntaxOn
\ifHy@ocgcolorlinks
  \pdf@ifdraftmode{}{
    \driver_pdf_object_new:nn   { l__hyp_ocg_view_dict_obj }  { dict }
    \driver_pdf_object_new:nn   { l__hyp_ocg_print_dict_obj } { dict }
    \driver_pdf_object_new:nn   { l__hyp_ocg_ref_array_obj }   { array }
    \driver_pdf_object_write:nn { l__hyp_ocg_view_dict_obj }
     {
        /Type/OCG
        /Name(View)
        /Usage
         <<
          /Print <</PrintState/OFF>>~
          /View  <</ViewState/ON  >>~
         >>
     }
    \driver_pdf_object_write:nn { l__hyp_ocg_print_dict_obj }
     {
        /Type/OCG
        /Name(Print)
        /Usage
         <<
          /Print <</PrintState/ON>>~
          /View  <</ViewState/OFF>>~
         >>
     }
    \driver_pdf_object_write:nx { l__hyp_ocg_ref_array_obj }
    {
        \driver_pdf_object_ref:n { l__hyp_ocg_view_dict_obj }
        \c_space_tl
        \driver_pdf_object_ref:n { l__hyp_ocg_print_dict_obj }
    }
    \pdf_catalog_gput:nn
     {OCProperties}
     {<<
        /OCGs~\driver_pdf_object_ref:n { l__hyp_ocg_ref_array_obj }
        ~
        /D<<
          /OFF[\driver_pdf_object_ref:n { l__hyp_ocg_print_dict_obj }]
          /AS[
            <<
              /Event/View
              /OCGs\c_space_tl \driver_pdf_object_ref:n { l__hyp_ocg_ref_array_obj }
              /Category[/View]
            >>
            <<
              /Event/Print
              /OCGs\c_space_tl \driver_pdf_object_ref:n { l__hyp_ocg_ref_array_obj }
              /Category[/Print]
            >>
            <<
              /Event/Export
              /OCGs\c_space_tl \driver_pdf_object_ref:n { l__hyp_ocg_ref_array_obj }
              /Category[/Print]
            >>
          ]
        >>
      >>
     }
    \begingroup
      \edef\x{\endgroup
        \pdfpageresources{
          \the\pdfpageresources
          /Properties<<
            /OCView ~ \driver_pdf_object_ref:n { l__hyp_ocg_view_dict_obj}
            /OCPrint~ \driver_pdf_object_ref:n { l__hyp_ocg_print_dict_obj}
          >>
        }
      }
    \x
  }
  \Hy@AtBeginDocument{
    \def\Hy@colorlink#1{
      \begingroup
        \ifHy@ocgcolorlinks
          \def\Hy@ocgcolor{#1}
          \setbox0=\hbox\bgroup\color@begingroup
        \else
          \HyColor@UseColor#1
        \fi
    }
    \def\Hy@endcolorlink{
      \ifHy@ocgcolorlinks
        \color@endgroup\egroup
        \mbox{
          %this uses a named object, we really need to sort this ...
          \pdfliteral~page{/OC/OCPrint~BDC}
          \rlap{\copy0}
          \driver_pdf_emc:
          \pdfliteral~page{/OC/OCView~BDC}
          \begingroup
            \expandafter\HyColor@UseColor\Hy@ocgcolor
            \box0~
          \endgroup
          \driver_pdf_emc:
        }
      \fi
      \endgroup
    }
  }
\else
  \Hy@DisableOption{ocgcolorlinks}
\fi

\def\setpdflinkmargin#1
 {
   \driver_pdf_link_margin:n { #1 }
 }
 % default:
 \driver_pdf_link_margin:n { 1pt}
\ExplSyntaxOff


\providecommand*\@pdfview{XYZ}
\Hy@WrapperDef\new@pdflink#1{%
  \ifhmode
    \@savsf\spacefactor
  \fi
  \Hy@SaveLastskip
  \Hy@VerboseAnchor{#1}%
  \Hy@pstringdef\Hy@pstringDest{\HyperDestNameFilter{#1}}%
  \Hy@DestName\Hy@pstringDest\@pdfview
  \Hy@RestoreLastskip
  \ifhmode
    \spacefactor\@savsf
  \fi
}
\let\pdf@endanchor\@empty

\ExplSyntaxOn
\def\Hy@DestName#1#2
 {
  \pdf_destination:nf {#1}{#2}
 }
\ExplSyntaxOff
\providecommand*\@pdfborder{0 0 1}
\providecommand*\@pdfborderstyle{}
\def\Hy@undefinedname{UNDEFINED}
\def\find@pdflink#1#2{%
  \leavevmode
  \protected@edef\Hy@testname{#2}%
  \ifx\Hy@testname\@empty
    \Hy@Warning{%
      Empty destination name,\MessageBreak
      using `\Hy@undefinedname'%
    }%
    \let\Hy@testname\Hy@undefinedname
  \else
    \Hy@pstringdef\Hy@testname{%
      \expandafter\HyperDestNameFilter\expandafter{\Hy@testname}%
    }%
  \fi
  \Hy@StartlinkName{%
    %\ifHy@pdfa /F 4\fi
%    \Hy@setpdfborder
%    \Hy@setpdfhighlight
%    \ifx\CurrentBorderColor\relax
%    \else
%      /C[\CurrentBorderColor]%
%    \fi
  }\Hy@testname
  \expandafter\Hy@colorlink\csname @#1color\endcsname
}

\ExplSyntaxOn
\def\Hy@StartlinkName#1#2
 {
  \pdf_link_begin_goto:nnw { link } { #2 } %%%
 }


\def\close@EXPpdflink#1{%
  \Hy@endcolorlink
  \Hy@VerboseLinkStop
  \pdf_link_end:n { #1 }
}

\def\close@pdflink{%
  \Hy@endcolorlink
  \Hy@VerboseLinkStop
  \pdfendlink
}
\ExplSyntaxOff
\def\hyper@anchor#1{%
  \new@pdflink{#1}\anchor@spot\pdf@endanchor
}
\def\hyper@anchorstart#1{%
  \new@pdflink{#1}%
  \Hy@activeanchortrue
}
\def\hyper@anchorend{%
  \pdf@endanchor
  \Hy@activeanchorfalse
}

\ExplSyntaxOn
% #1 is for the color only: found {cite} and {link}
% #2 is the destination find@pdflink uses then named link
\def\hyper@linkstart#1#2{%
  \Hy@VerboseLinkStart{#1}{#2}% only for debug
  \tl_if_exist:cTF            %or test for blank??
   { @#1bordercolor }
   {
    \hook_put:nnnn
     { pdf }
     { link_begin_link_attr }
     { /C }{ [\tl_use:c { @#1bordercolor }] } %do I need to expand?? seems not
   }
   {
    \hook_remove:nnn
     { pdf }
     { link_begin_link_attr }
     { /C }
   }
  \find@pdflink{#1}{#2}% #1=color type
}

% the endlink muss have the same type as the start?
% probably always link works
\def\hyper@linkend
 {
  \close@EXPpdflink { link }
 }

\def\hyper@link#1#2#3
 {
  \Hy@VerboseLinkStart{#1}{#2}
  \tl_if_exist:cTF
   { @#1bordercolor }
   {
    \hook_put:nnnn
     { pdf }
     { link_begin_link_attr }
     { /C }{ [\tl_use:c { @#1bordercolor }] } %do I need to expand?? seems not
   }
   {
    \hook_remove:nnn
     { pdf }
     { link_begin_link_attr }
     { /C }
   }
  \find@pdflink{#1}{#2}#3\Hy@xspace@end
  \close@EXPpdflink { link }
}
\ExplSyntaxOff

\let\CurrentBorderColor\@linkbordercolor
\ExplSyntaxOn
%% this command is used for \url
\def\hyper@linkurl#1#2{%#1:link text #2: URI,
  \group_begin:
    \Hy@pstringdef\Hy@pstringURI{#2}%
    \hyper@chars
    \mode_leave_vertical:
    \pdf_link_user:nnn { url }
     {
       /A<<
         /Type/Action~
         /S/URI~
         /URI(\Hy@pstringURI)~
         \ifHy@href@ismap
           /IsMap~true~
         \fi
         \Hy@href@nextactionraw
       >>
    }
    {
     \Hy@colorlink
     \@urlcolor#1\Hy@xspace@end
     \Hy@endcolorlink
     \Hy@VerboseLinkStop
    }
  \group_end:
}
\ExplSyntaxOff

\ExplSyntaxOn
%file links (need to find out when exactly it is used ...)
\def\hyper@linkfile#1#2#3{% anchor text, filename, linkname
  \group_begin:
    \def\Hy@pstringF{#2}%
    \Hy@CleanupFile\Hy@pstringF
    \Hy@pstringdef\Hy@pstringF\Hy@pstringF
    \Hy@pstringdef\Hy@pstringD{#3}
    \Hy@MakeRemoteAction
    \mode_leave_vertical:
    \pdf_link_user:nnn
     { file }
     {
       /A<<
          /F(\Hy@pstringF)
          /S/GoToR
          \Hy@SetNewWindow
          \ifx\\#3\\
            /D[\Hy@href@page\@pdfremotestartview]
          \else
            /D(\Hy@pstringD)
          \fi
          \Hy@href@nextactionraw
        >>
     }
     {
       \Hy@colorlink
        \@filecolor#1\Hy@xspace@end
       \Hy@endcolorlink
       \Hy@VerboseLinkStop
     }
  \group_end:
}
\ExplSyntaxOff

\ExplSyntaxOn
% use by run links xxxxxxxxxxx
\def\@hyper@launch run:#1\\#2#3 % filename, anchor text linkname
 {
  \group_begin:
    \Hy@pstringdef\Hy@pstringF{#1}%
    \Hy@pstringdef\Hy@pstringP{#3}%
    \mode_leave_vertical:
    \pdf_link_user:nnn
     { run }
     {
      /A<<
          /F(\Hy@pstringF)
          /S/Launch
          \Hy@SetNewWindow
          \ifx\\#3\\
          \else
            /Win<</P(\Hy@pstringP)/F(\Hy@pstringF)>>
          \fi
          \Hy@href@nextactionraw
        >>
      }
      {
       \Hy@colorlink
        \@runcolor#2\Hy@xspace@end
       \Hy@endcolorlink
       \Hy@VerboseLinkStop
      }
  \group_end:
}


%this needs central management in the kernel
\def\PDF@SetupDoc{
  \ifx\@pdfpagescrop\@empty
  \else
    \edef\process@me{
      \pdfpagesattr={
        /CropBox[\@pdfpagescrop]%
        \expandafter\ifx\expandafter\\\the\pdfpagesattr\\%
        \else
          ^^J\the\pdfpagesattr
        \fi
      }%
    }%
    \process@me
  \fi
  \Hy@pstringdef\Hy@pstringB{\@baseurl}%
  \pdf_catalog_gput:nn {PageMode}{/\@pdfpagemode}
  \tl_if_empty:NF \@baseurl
   {
    \pdf_catalog_gput:nn {URI}{<</Base(\Hy@pstringB)>>}
   }
  %
  \ifx\@pdfstartpage\@empty
  \else
    \ifx\@pdfstartview\@empty
    \else
      openaction~goto~page\@pdfstartpage{\@pdfstartview}%
    \fi
  \fi
  \edef\Hy@temp{%
    \ifHy@pdftoolbar\else /HideToolbar\c_space_tl true\fi
    \ifHy@pdfmenubar\else /HideMenubar\c_space_tl true\fi
    \ifHy@pdfwindowui\else /HideWindowUI\c_space_tl true\fi
    \ifHy@pdffitwindow /FitWindow\c_space_tl true\fi
    \ifHy@pdfcenterwindow /CenterWindow\c_space_tl true\fi
    \ifHy@pdfdisplaydoctitle /DisplayDocTitle\c_space_tl true\fi
    \Hy@UseNameKey{NonFullScreenPageMode}\@pdfnonfullscreenpagemode
    \Hy@UseNameKey{Direction}\@pdfdirection
    \Hy@UseNameKey{ViewArea}\@pdfviewarea
    \Hy@UseNameKey{ViewClip}\@pdfviewclip
    \Hy@UseNameKey{PrintArea}\@pdfprintarea
    \Hy@UseNameKey{PrintClip}\@pdfprintclip
    \Hy@UseNameKey{PrintScaling}\@pdfprintscaling
    \Hy@UseNameKey{Duplex}\@pdfduplex
    \ifx\@pdfpicktraybypdfsize\@empty
    \else
      /PickTrayByPDFSize \@pdfpicktraybypdfsize
    \fi
    \ifx\@pdfprintpagerange\@empty
    \else
      /PrintPageRange[\@pdfprintpagerange]%
    \fi
    \ifx\@pdfnumcopies\@empty
    \else
      /NumCopies\c_space_tl \@pdfnumcopies
    \fi
  }%
    \ifx\Hy@temp\@empty
    \else
    \pdf_catalog_gput:nn
     {ViewerPreferences}{<<\Hy@temp>>}%
    \fi
    %% \Hy@UseNameKey{PageLayout}\@pdfpagelayout <------?????
    \ifx\@pdflang\relax
    \else
      \pdf_catalog_gput:nn
       { Lang }
       {(\@pdflang)}%
    \fi

}


\def\PDF@FinishDoc{%
  \pdf@ifdraftmode{}{%
    \Hy@UseMaketitleInfos
    \HyInfo@GenerateAddons
    \pdf_info_gput:nn
      {Author}{(\@pdfauthor)}
    \pdf_info_gput:nn
      {Title}{(\@pdftitle)}
    \pdf_info_gput:nn
      {Subject}{(\@pdfsubject)}
    \pdf_info_gput:nn
      {Creator}{(\@pdfcreator)} %hm should hyperref set this in any case??
    \tl_if_empty:NF
       {\@pdfcreationdate}
       {
        \pdf_info_gput:nn
         {CreationDate}{(\@pdfcreationdate)}
       }
     \tl_if_empty:NF
       \@pdfmoddate
       {
        \pdf_info_gput:nn
         {ModDate}{(\@pdfmoddate)}
       }
     \tl_if_exist:NT %special, as \relax is default
       \@pdfproducer
       {
        \pdf_info_gput:nn
         {Producer}{(\@pdfproducer)}
       }
     \pdf_info_gput:nn
       {Keywords}{(\@pdfkeywords)}
     \tl_if_empty:NF
       {\@pdftrapped}
       {
        \pdf_info_gput:nn
        {Trapped}{/\@pdftrapped}
       }
      %\HyInfo@Addons % unclear ....needs probably change in hyperref
      \pdf_info_out: % where should this go????
    }
  \Hy@DisableOption{pdfauthor}%
  \Hy@DisableOption{pdftitle}%
  \Hy@DisableOption{pdfsubject}%
  \Hy@DisableOption{pdfcreator}%
  \Hy@DisableOption{pdfcreationdate}%
  \Hy@DisableOption{pdfmoddate}%
  \Hy@DisableOption{pdfproducer}%
  \Hy@DisableOption{pdfkeywords}%
  \Hy@DisableOption{pdftrapped}%
  \Hy@DisableOption{pdfinfo}%
}
 \ExplSyntaxOff
\def\hyper@pagetransition{%
  \ifx\@pdfpagetransition\relax
  \else
    \expandafter\Hy@RemoveTransPageAttr
    \the\pdfpageattr^^J/Trans{}>>\END
    \ifx\@pdfpagetransition\@empty
    \else
      \edef\@processme{%
        \global\pdfpageattr{%
          \the\pdfpageattr
          ^^J/Trans << /S /\@pdfpagetransition\space >>%
        }%
      }%
      \@processme
    \fi
  \fi
}
\gdef\Hy@RemoveTransPageAttr#1^^J/Trans#2#3>>#4\END{%
  \ifx\\#2\\%
    \global\pdfpageattr{#1}%
  \else
    \Hy@RemoveTransPageAttr#1#4\END
  \fi
}
\def\hyper@pageduration{%
  \ifx\@pdfpageduration\relax
  \else
    \expandafter
    \Hy@RemoveDurPageAttr\the\pdfpageattr^^J/Dur{} \END
    \ifx\@pdfpageduration\@empty
    \else
      \edef\@processme{%
        \global\pdfpageattr{%
          \the\pdfpageattr
          ^^J/Dur \@pdfpageduration\space
        }%
      }%
      \@processme
    \fi
  \fi
}
\gdef\Hy@RemoveDurPageAttr#1^^J/Dur#2#3 #4\END{%
  \ifx\\#2\\%
    \global\pdfpageattr{#1}%
  \else
    \Hy@RemoveDurPageAttr#1#4\END
  \fi
}
%UF removed hyper@pagehidden (obsolete key)
%   removed \Hy@RemoveHidPageAttr#1^^J/Hid#2#3 #4\END{%

\pdf@ifdraftmode{}{%
  \g@addto@macro\Hy@EveryPageHook{%
    \hyper@pagetransition
    \hyper@pageduration
    %\hyper@pagehidden %UF is obsolete
  }%
}

%%% UF removed setpagesize code, should be done by kernel/graphicx
\ExplSyntaxOn
\def\Acrobatmenu#1#2{%
  \Hy@Acrobatmenu{#1}{#2}{%
    \mode_leave_vertical:
    \EdefEscapeName\Hy@temp@menu{#1}%
    \pdf_link_user:nnn { menu }
      {
       /A<<
          /S/Named
          /N/\Hy@temp@menu
          \Hy@href@nextactionraw
        >>

      }
      {
       \Hy@colorlink\@menucolor#2
       \Hy@xspace@end
       \Hy@endcolorlink
       \Hy@VerboseLinkStop
      }
  }
}
\ExplSyntaxOff
%%% UF removed old atbegshi fix

\def\@Gauge[#1]#2#3#4{% parameters, label, minimum, maximum
  \Hy@Message{Sorry, pdftex does not support FORM gauges}%
}
\def\MakeFieldObject#1#2{\sbox0{#1}%
  \immediate\saveboxresource0 %
  \expandafter\edef\csname #2Object\endcsname{%
    \the\lastsavedboxresourceindex\space 0 R%
  }%
}%
\let\HyField@afields\ltx@empty
\let\HyField@cofields\ltx@empty
%% UF test for old pdftex removed
  \let\HyField@AuxAddToFields\ltx@gobble
  \let\HyField@AuxAddToCoFields\ltx@gobbletwo
  \def\HyField@AfterAuxOpen{\Hy@AtBeginDocument}%

\ExplSyntaxOn

  \def\HyField@ABD@AuxAddToCoFields#1#2{%
    \group_begin:
      \Hy@safe@activestrue
      \let\ltx@secondoftwo\relax
      \ifx\HyField@cofields\ltx@empty
        \xdef\HyField@cofields{%
          \ltx@secondoftwo{#1}{ #2 ~ 0 ~ R}%
        }
      \else
        \let\ltx@secondoftwo\relax
        \def\HyField@AddCoField##1##2##3{%
          \ifx##1\ltx@empty
            \ltx@secondoftwo{#1}{ #2 ~ 0 ~ R}%
            \expandafter\ltx@gobble
          \else
            \ifnum\pdf@strcmp{##2}{#1}>\ltx@zero
              \ltx@secondoftwo{#1}{ #2 ~ 0 ~ R}%
              \ltx@secondoftwo{##2}{##3}%
              \expandafter\expandafter\expandafter\ltx@gobble
            \else
              \ltx@secondoftwo{##2}{##3}%
            \fi
          \fi
          \HyField@AddCoField
        }%
        \xdef\HyField@cofields{%
          \expandafter\HyField@AddCoField
          \HyField@cofields\ltx@empty\ltx@empty\ltx@empty
        }%
      \fi
    \group_end:
  }%

  \Hy@AtBeginDocument{%
    \if@filesw
      \immediate\write\@mainaux{%
        \string\providecommand\string\HyField@AuxAddToFields[1]{}%
      }%
      \immediate\write\@mainaux{%
        \string\providecommand\string\HyField@AuxAddToCoFields[2]{}%
      }%
    \fi
    \let\HyField@AfterAuxOpen\@firstofone
    \def\HyField@AuxAddToFields#1{%
      \xdef\HyField@afields{%
        \ifx\HyField@afields\@empty
        \else
          \HyField@afields
          \space
        \fi
        #1 ~ 0 ~ R%
      }%
    }%
    \let\HyField@AuxAddToCoFields\HyField@ABD@AuxAddToCoFields
  }%
  \def\HyField@AddToFields{%
    \expandafter\HyField@@AddToFields\expandafter{%
      \the\driver_pdf_link_last_int:
    }%
    \ifx\Fld@calculate@code\ltx@empty
    \else
      \begingroup
        \Hy@safe@activestrue
        \edef\Hy@temp{%
          \endgroup
          \if@filesw
            \write\@mainaux{%
              \string\HyField@AuxAddToCoFields{%
                \Fld@calculate@sortkey
              }{%
                \the\driver_pdf_link_last_int:
              }%
            }%
          \fi
        }%
      \Hy@temp
    \fi
  }%
  \def\HyField@@AddToFields#1{%
    \HyField@AfterAuxOpen{%
      \if@filesw
        \write\@mainaux{%
          \string\HyField@AuxAddToFields{#1}%
        }%
      \fi
    }%
  }%

\ExplSyntaxOff
\ExplSyntaxOn

\def\@Form[#1]
 {
  \@ifundefined{textcolor}{\let\textcolor\@gobble}{}
  \kvsetkeys{Form}{#1}
  \pdf@ifdraftmode{}
   {
    \Hy@FormObjects
    \AtVeryEndDocument
     {
      \driver_pdf_object_new:nn   { l__hyp_acroform_dict_obj } {dict}
      \driver_pdf_object_write:nx { l__hyp_acroform_dict_obj }
      {
        /Fields[\HyField@afields]
        \ifx\HyField@cofields\ltx@empty
        \else
           /CO[\romannumeral-`\Q\HyField@cofields]%
         \fi
        /DR<<
            /Font<<
              /ZaDb~\driver_pdf_object_ref:n {l__hyp_font_zapfdingbats_obj}~
              /Helv~\driver_pdf_object_ref:n {l__hyp_font_helvetica_obj}
            >>
          >>
          /DA(/Helv~10~Tf~0~g)
          \ifHy@pdfa %???????
          \else
            \ifHyField@NeedAppearances
              /NeedAppearances~true%
            \fi
          \fi
      }
      \driver_pdf_catalog_gput:nn{AcroForm}{\driver_pdf_object_ref:n{l__hyp_acroform_dict_obj}}%
    }
  }
  \MakeFieldObject
   {
    \group_begin:
      \fontfamily{pzd}
      \fontencoding{U}
      \fontseries{m}
      \fontshape{n}
      \selectfont
      \char123
    \group_end:
   }{Ding}
  \MakeFieldObject
   {
    \fbox{\textcolor{yellow}{\textsf{Submit}}} %color?
   }{Submit}
  \MakeFieldObject
   {
    \fbox{\textcolor{yellow}{\textsf{SubmitP}}} %color?
   }{SubmitP}
}
\ExplSyntaxOff
\let\@endForm\ltx@empty
\let\HyAnn@AbsPageLabel\ltx@empty
\let\Fld@pageobjref\ltx@empty
\ltx@IfUndefined{pdfpageref}{%
}{%
  \ltx@ifpackageloaded{zref-abspage}{%
    \newcount\HyAnn@Count
    \HyAnn@Count=\ltx@zero
    \def\HyAnn@AbsPageLabel{%
      \global\advance\HyAnn@Count by\ltx@one
      \zref@labelbyprops{HyAnn@\the\HyAnn@Count}{abspage}%
      \zref@refused{HyAnn@\the\HyAnn@Count}%
    }%
    \def\Fld@pageobjref{%
      \zref@ifrefundefined{HyAnn@\the\HyAnn@Count}{%
      }{%
        \zref@ifrefcontainsprop{HyAnn@\the\HyAnn@Count}{abspage}{%
          /P \pdfpageref
          \zref@extractdefault{HyAnn@\the\HyAnn@Count}{abspage}{1} %
          \space 0 R%
        }{%
        }%
      }%
    }%
  }{%
  }%
}
\def\@TextField[#1]#2{% parameters, label
  \def\Fld@name{#2}%
  \let\Fld@default\ltx@empty
  \let\Fld@value\@empty
  \def\Fld@width{\DefaultWidthofText}%
  \def\Fld@height{%
    \ifFld@multiline
      \DefaultHeightofTextMultiline
    \else
      \DefaultHeightofText
    \fi
  }%
  \begingroup
    \expandafter\HyField@SetKeys\expandafter{%
      \DefaultOptionsofText,#1%
    }%
    \PDFForm@Name
    \HyField@FlagsText
    \ifFld@hidden\def\Fld@width{1sp}\fi
    \ifx\Fld@value\@empty\def\Fld@value{\Fld@default}\fi
    \LayoutTextField{#2}{%
      \leavevmode
      \HyAnn@AbsPageLabel
      \Hy@escapeform\PDFForm@Text
      \pdfstartlink user {\PDFForm@Text}\relax
      \MakeTextField{\Fld@width}{\Fld@height}\pdfendlink
      \HyField@AddToFields
    }%
  \endgroup
}
\def\@ChoiceMenu[#1]#2#3{% parameters, label, choices
  \def\Fld@name{#2}%
  \let\Fld@default\relax
  \let\Fld@value\relax
  \def\Fld@width{\DefaultWidthofChoiceMenu}%
  \def\Fld@height{\DefaultHeightofChoiceMenu}%
  \begingroup
    \Fld@menulength=0 %
    \@tempdima\z@
    \@for\@curropt:=#3\do{%
      \expandafter\Fld@checkequals\@curropt==\\%
      \Hy@StepCount\Fld@menulength
      \settowidth{\@tempdimb}{\@currDisplay}%
      \ifdim\@tempdimb>\@tempdima\@tempdima\@tempdimb\fi
    }%
    \advance\@tempdima by 15\p@
    \begingroup
      \HyField@SetKeys{#1}%
    \edef\x{\endgroup
      \noexpand\expandafter
      \noexpand\HyField@SetKeys
      \noexpand\expandafter{%
        \expandafter\noexpand\csname DefaultOptionsof%
          \ifFld@radio
            Radio%
          \else
            \ifFld@combo
              \ifFld@popdown
                PopdownBox%
              \else
                ComboBox%
              \fi
            \else
              ListBox%
            \fi
          \fi
        \endcsname
      }%
    }\x
    \HyField@SetKeys{#1}%
    \PDFForm@Name
    \ifFld@hidden\def\Fld@width{1sp}\fi
    \ifx\Fld@value\relax
      \let\Fld@value\Fld@default
    \fi
    \LayoutChoiceField{#2}{%
      \ifFld@radio
        \HyField@FlagsRadioButton
        \@@Radio{#3}%
      \else
        \begingroup
          \HyField@FlagsChoice
          \ifdim\Fld@width<\@tempdima
            \ifdim\@tempdima<1cm\@tempdima1cm\fi
            \edef\Fld@width{\the\@tempdima}%
          \fi
          \ifFld@combo
          \else
            \@tempdima=\the\Fld@menulength\Fld@charsize
            \advance\@tempdima by \Fld@borderwidth bp %
            \advance\@tempdima by \Fld@borderwidth bp %
            \edef\Fld@height{\the\@tempdima}%
          \fi
          \@@Listbox{#3}%
        \endgroup
      \fi
    }%
  \endgroup
}
\def\@@Radio#1{%
  \Fld@listcount=0 %
  \EdefEscapeName\Fld@default{\Fld@default}%
  \@for\@curropt:=#1\do{%
    \expandafter\Fld@checkequals\@curropt==\\%
    \EdefEscapeName\@currValue{\@currValue}%
    \Hy@StepCount\Fld@listcount
    \@currDisplay\space
    \leavevmode
    \HyAnn@AbsPageLabel
    \Hy@escapeform\PDFForm@Radio
    \pdfstartlink user {%
      \PDFForm@Radio
      /AP<<%
        /N<<%
          /\@currValue\space \DingObject
        >>%
      >>%
    }%
    \relax
    \MakeRadioField{\Fld@width}{\Fld@height}\pdfendlink
    \ifnum\Fld@listcount=1 %
      \HyField@AddToFields
    \fi
    \space % deliberate space between radio buttons
  }%
}
\newcount\Fld@listcount
\def\@@Listbox#1{%
  \HyField@PDFChoices{#1}%
  \leavevmode
  \HyAnn@AbsPageLabel
  \Hy@escapeform\PDFForm@List
  \pdfstartlink user {\PDFForm@List}\relax
  \MakeChoiceField{\Fld@width}{\Fld@height}%
  \pdfendlink
  \HyField@AddToFields
}
\def\@PushButton[#1]#2{% parameters, label
  \def\Fld@name{#2}%
  \begingroup
    \expandafter\HyField@SetKeys\expandafter{%
      \DefaultOptionsofPushButton,#1%
    }%
    \PDFForm@Name
    \ifHy@pdfa
      \Hy@Error{%
        PDF/A: Push button with JavaScript is prohibited%
      }\@ehc
      \LayoutPushButtonField{%
        \leavevmode
        \MakeButtonField{#2}%
      }%
    \else
      \HyField@FlagsPushButton
      \ifFld@hidden\def\Fld@width{1sp}\fi
      \LayoutPushButtonField{%
        \leavevmode
        \HyAnn@AbsPageLabel
        \Hy@escapeform\PDFForm@Push
        \pdfstartlink user {\PDFForm@Push}\relax
        \MakeButtonField{#2}%
        \pdfendlink
        \HyField@AddToFields
      }%
    \fi
  \endgroup
}
\def\@Submit[#1]#2{%
  \def\Fld@width{\DefaultWidthofSubmit}%
  \def\Fld@height{\DefaultHeightofSubmit}%
  \begingroup
    \expandafter\HyField@SetKeys\expandafter{%
      \DefaultOptionsofSubmit,#1%
    }%
    \HyField@FlagsPushButton
    \HyField@FlagsSubmit
    \ifFld@hidden\def\Fld@width{1sp}\fi
    \leavevmode
    \HyAnn@AbsPageLabel
    \Hy@escapeform\PDFForm@Submit
    \pdfstartlink user {%
      \PDFForm@Submit
      /AP<</N \SubmitObject/D \SubmitPObject>>%
    }%
    \relax
    \MakeButtonField{#2}%
    \pdfendlink
    \HyField@AddToFields
  \endgroup
}
\def\@Reset[#1]#2{%
  \def\Fld@width{\DefaultWidthofReset}%
  \def\Fld@height{\DefaultHeightofReset}%
  \begingroup
    \expandafter\HyField@SetKeys\expandafter{%
      \DefaultOptionsofReset,#1%
    }%
    \leavevmode
    \ifHy@pdfa
      \Hy@Error{%
        PDF/A: Reset action is prohibited%
      }\@ehc
      \MakeButtonField{#2}%
    \else
      \HyField@FlagsPushButton
      \ifFld@hidden\def\Fld@width{1sp}\fi
      \HyAnn@AbsPageLabel
      \Hy@escapeform\PDFForm@Reset
      \pdfstartlink user {\PDFForm@Reset}\relax
      \MakeButtonField{#2}%
      \pdfendlink
      \HyField@AddToFields
    \fi
  \endgroup
}
\def\@CheckBox[#1]#2{% parameters, label
  \def\Fld@name{#2}%
  \def\Fld@default{0}%
  \begingroup
    \def\Fld@width{\DefaultWidthofCheckBox}%
    \def\Fld@height{\DefaultHeightofCheckBox}%
    \expandafter\HyField@SetKeys\expandafter{%
      \DefaultOptionsofCheckBox,#1%
    }%
    \PDFForm@Name
    \HyField@FlagsCheckBox
    \ifFld@hidden\def\Fld@width{1sp}\fi
    \LayoutCheckField{#2}{%
      \leavevmode
      \HyAnn@AbsPageLabel
      \Hy@escapeform\PDFForm@Check
      \pdfstartlink user {\PDFForm@Check}\relax
      \MakeCheckField{\Fld@width}{\Fld@height}%
      \pdfendlink
      \HyField@AddToFields
    }%
  \endgroup
}
%hm. Should a luatex driver use type1 fonts in fields????
\ExplSyntaxOn
\def\Hy@FormObjects{%
  \driver_pdf_object_new:nn   {l__hyp_encoding_pdfdoc_obj } { dict }
  \driver_pdf_object_new:nn   {l__hyp_font_zapfdingbats_obj } { dict }
  \driver_pdf_object_new:nn   {l__hyp_font_helvetica_obj } { dict }
  \driver_pdf_object_write:nx {l__hyp_encoding_pdfdoc_obj }
   {
      /Type/Encoding
      /Differences[
        24/breve/caron/circumflex/dotaccent/hungarumlaut/ogonek
          /ring/tilde
        \c_space_tl
        39/quotesingle
        \c_space_tl
        96/grave %
        \iow_newline:
        128/bullet/dagger/daggerdbl/ellipsis/emdash/endash/florin
           /fraction/guilsinglleft/guilsinglright/minus/perthousand
           /quotedblbase/quotedblleft/quotedblright/quoteleft
           /quoteright/quotesinglbase/trademark/fi/fl/Lslash/OE
           /Scaron/Ydieresis/Zcaron/dotlessi/lslash/oe/scaron/zcaron
        \iow_newline:
        164/currency
        \c_space_tl
        166/brokenbar
        \c_space_tl
        168/dieresis/copyright/ordfeminine
        \c_space_tl
        172/logicalnot/.notdef/registered/macron/degree/plusminus
           /twosuperior/threesuperior/acute/mu
        \c_space_tl
        183/periodcentered/cedilla/onesuperior/ordmasculine
        \c_space_tl
        188/onequarter/onehalf/threequarters
        \iow_newline:
        192/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
           /Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave
           /Iacute/Icircumflex/Idieresis/Eth/Ntilde/Ograve/Oacute
           /Ocircumflex/Otilde/Odieresis/multiply/Oslash/Ugrave
           /Uacute/Ucircumflex/Udieresis/Yacute/Thorn/germandbls
           /agrave/aacute/acircumflex/atilde/adieresis/aring/ae
           /ccedilla/egrave/eacute/ecircumflex/edieresis/igrave
           /iacute/icircumflex/idieresis/eth/ntilde/ograve/oacute
           /ocircumflex/otilde/odieresis/divide/oslash/ugrave
           /uacute/ucircumflex/udieresis/yacute/thorn/ydieresis
      ]
  }
  \driver_pdf_object_write:nn {l__hyp_font_zapfdingbats_obj }
   {
      /Type/Font
      /Subtype/Type1
      /Name/ZaDb
      /BaseFont/ZapfDingbats
   }
  \driver_pdf_object_write:nx {l__hyp_font_helvetica_obj }
   {
      /Type/Font
      /Subtype/Type1
      /Name/Helv
      /BaseFont/Helvetica
      /Encoding~\driver_pdf_object_ref:n { l__hyp_encoding_pdfdoc_obj }
   }
  \global\let\Hy@FormObjects\relax
}
\ExplSyntaxOff
\providecommand*{\Fld@pageobjref}{}
\begingroup\expandafter\expandafter\expandafter\endgroup
\expandafter\ifx\csname pdf@escapestring\endcsname\relax
  \let\Hy@escapestring\@firstofone
  \def\Hy@escapeform#1{%
    \ifHy@pdfescapeform
      \def\Hy@escapestring##1{%
        \noexpand\Hy@escapestring{\noexpand##1}%
      }%
      \edef\Hy@temp{#1}%
      \expandafter\Hy@@escapeform\Hy@temp\Hy@escapestring{}\@nil
      \def\Hy@escapestring##1{%
        \@ifundefined{Hy@esc@\string##1}{%
          ##1%
          \ThisShouldNotHappen
        }{%
          \csname Hy@esc@\string##1\endcsname
        }%
      }%
    \else
      \let\Hy@escapestring\@firstofone
    \fi
  }%
  \def\Hy@@escapeform#1\Hy@escapestring#2#3\@nil{%
    \ifx\\#3\\%
    \else
      \expandafter
      \Hy@pstringdef\csname Hy@esc@\string#2\endcsname{#2}%
      \ltx@ReturnAfterFi{%
        \Hy@@escapeform#3\@nil
      }%
    \fi
  }%
\else
  \def\Hy@escapeform#1{%
    \ifHy@pdfescapeform
      \let\Hy@escapestring\pdfescapestring
    \else
      \let\Hy@escapestring\@firstofone
    \fi
  }%
  \Hy@escapeform{}%
\fi
\def\PDFForm@Name{%
  \PDFForm@@Name\Fld@name
  \ifx\Fld@altname\relax
  \else
    \PDFForm@@Name\Fld@altname
  \fi
  \ifx\Fld@mappingname\relax
  \else
    \PDFForm@@Name\Fld@mappingname
  \fi
}
\def\PDFForm@@Name#1{%
  \begingroup
    \ifnum\Hy@pdfversion<5 % implementation note 117, PDF spec 1.7
      \ifHy@unicode
        \Hy@unicodefalse
      \fi
    \fi
    \HyPsd@XeTeXBigCharstrue
    \pdfstringdef\Hy@gtemp#1%
  \endgroup
  \let#1\Hy@gtemp
}
\def\Fld@@additionalactions{%
  \ifx\Fld@keystroke@code\@empty
  \else
    /K<</S/JavaScript/JS(\Hy@escapestring{\Fld@keystroke@code})>>%
  \fi
  \ifx\Fld@format@code\@empty
  \else
    /F<</S/JavaScript/JS(\Hy@escapestring{\Fld@format@code})>>%
  \fi
  \ifx\Fld@validate@code\@empty
  \else
    /V<</S/JavaScript/JS(\Hy@escapestring{\Fld@validate@code})>>%
  \fi
  \ifx\Fld@calculate@code\@empty
  \else
    /C<</S/JavaScript/JS(\Hy@escapestring{\Fld@calculate@code})>>%
  \fi
  \ifx\Fld@onfocus@code\@empty
  \else
    /Fo<</S/JavaScript/JS(\Hy@escapestring{\Fld@onfocus@code})>>%
  \fi
  \ifx\Fld@onblur@code\@empty
  \else
    /Bl<</S/JavaScript/JS(\Hy@escapestring{\Fld@onblur@code})>>%
  \fi
  \ifx\Fld@onmousedown@code\@empty
  \else
    /D<</S/JavaScript/JS(\Hy@escapestring{\Fld@onmousedown@code})>>%
  \fi
  \ifx\Fld@onmouseup@code\@empty
  \else
    /U<</S/JavaScript/JS(\Hy@escapestring{\Fld@onmouseup@code})>>%
  \fi
  \ifx\Fld@onenter@code\@empty
  \else
    /E<</S/JavaScript/JS(\Hy@escapestring{\Fld@onenter@code})>>%
  \fi
  \ifx\Fld@onexit@code\@empty
  \else
    /X<</S/JavaScript/JS(\Hy@escapestring{\Fld@onexit@code})>>%
  \fi
}
\def\Fld@additionalactions{%
  \if-\Fld@@additionalactions-%
  \else
    \ifHy@pdfa
    \else
      /AA<<\Fld@@additionalactions>>%
    \fi
  \fi
}
\def\Fld@annotnames{%
  /T(\Fld@name)%
  \ifx\Fld@altname\relax
  \else
    /TU(\Fld@altname)%
  \fi
  \ifx\Fld@mappingname\relax
  \else
    /TM(\Fld@mappingname)%
  \fi
}
\def\PDFForm@Check{%
  /Subtype/Widget%
  \Fld@annotflags
  \Fld@pageobjref
  \Fld@annotnames
  /FT/Btn%
  \Fld@flags
  /Q \Fld@align
  /BS<</W \Fld@borderwidth /S/\Fld@borderstyle>>%
  /AP<< /N <</Yes<<>>>> >>  %new string /Yes is from below
  /MK<<%
    \ifnum\Fld@rotation=\z@
    \else
      /R \Fld@rotation
    \fi
    \ifx\Fld@bordercolor\relax
    \else
      /BC[\Fld@bordercolor]%
    \fi
    \ifx\Fld@bcolor\relax
    \else
      /BG[\Fld@bcolor]%
    \fi
    /CA(\Hy@escapestring{\Fld@cbsymbol})%
  >>%
  /DA(/ZaDb \strip@pt\Fld@charsize\space Tf%
      \ifx\Fld@color\@empty\else\space\Fld@color\fi)%
  /H/P%
  \ifFld@checked /V/Yes/AS/Yes\else /V/Off/AS/Off\fi
  \Fld@additionalactions
}
\ifHy@pdfa
\else
  \def\PDFForm@Push{%
    /Subtype/Widget%
    \Fld@annotflags
    \Fld@pageobjref
    \Fld@annotnames
    /FT/Btn%
    \Fld@flags
    /H/P%
    /BS<</W \Fld@borderwidth/S/\Fld@borderstyle>>%
    \ifcase0\ifnum\Fld@rotation=\z@   \else 1\fi
            \ifx\Fld@bordercolor\relax\else 1\fi
            \space
    \else
      /MK<<%
        \ifnum\Fld@rotation=\z@
        \else
          /R \Fld@rotation
        \fi
        \ifx\Fld@bordercolor\relax
        \else
          /BC[\Fld@bordercolor]%
        \fi
      >>%
    \fi
    /A<</S/JavaScript/JS(\Hy@escapestring{\Fld@onclick@code})>>%
    \Fld@additionalactions
  }%
\fi
\def\PDFForm@List{%
  /Subtype/Widget%
  \Fld@annotflags
  \Fld@pageobjref
  \Fld@annotnames
  /FT/Ch%
  \Fld@flags
  /Q \Fld@align
  /BS<</W \Fld@borderwidth/S/\Fld@borderstyle>>%
  \ifcase0\ifnum\Fld@rotation=\z@   \else 1\fi
          \ifx\Fld@bordercolor\relax\else 1\fi
          \ifx\fld@bcolor\relax     \else 1\fi
          \space
  \else
    /MK<<%
      \ifnum\Fld@rotation=\z@
      \else
        /R \Fld@rotation
      \fi
      \ifx\Fld@bordercolor\relax
      \else
        /BC[\Fld@bordercolor]%
      \fi
      \ifx\Fld@bcolor\relax
      \else
        /BG[\Fld@bcolor]%
      \fi
    >>%
  \fi
  /DA(/Helv \strip@pt\Fld@charsize\space Tf%
      \ifx\Fld@color\@empty\else\space\Fld@color\fi)%
  \Fld@choices
  \Fld@additionalactions
}
\def\PDFForm@Radio{%
  /Subtype/Widget%
  \Fld@annotflags
  \Fld@pageobjref
  \Fld@annotnames
  /FT/Btn%
  \Fld@flags
  /H/P%
  /BS<</W \Fld@borderwidth/S/\Fld@borderstyle>>%
  /MK<<%
    \ifnum\Fld@rotation=\z@
    \else
      /R \Fld@rotation
    \fi
    \ifx\Fld@bordercolor\relax
    \else
      /BC[\Fld@bordercolor]%
    \fi
    \ifx\Fld@bcolor\relax
    \else
      /BG[\Fld@bcolor]%
    \fi
    /CA(\Hy@escapestring{\Fld@radiosymbol})%
  >>%
  /DA(/ZaDb \strip@pt\Fld@charsize\space Tf%
      \ifx\Fld@color\@empty\else\space\Fld@color\fi)%
  \ifx\Fld@default\@empty
    /V/Off%
    /DV/Off%
  \else
   /V/\Fld@default
   /DV/\Fld@default
  \fi
  \Fld@additionalactions
}
\def\PDFForm@Text{%
  /Subtype/Widget%
  \Fld@annotflags
  \Fld@pageobjref
  \Fld@annotnames
  /FT/Tx%
  \Fld@flags
  /Q \Fld@align
  /BS<</W \Fld@borderwidth\space /S /\Fld@borderstyle>>%
  \ifcase0\ifnum\Fld@rotation=\z@   \else 1\fi
          \ifx\Fld@bordercolor\relax\else 1\fi
          \ifx\Fld@bcolor\relax     \else 1\fi
          \space
  \else
    /MK<<%
      \ifnum\Fld@rotation=\z@
      \else
        /R \Fld@rotation
      \fi
      \ifx\Fld@bordercolor\relax
      \else
        /BC[\Fld@bordercolor]%
      \fi
      \ifx\Fld@bcolor\relax
      \else
        /BG[\Fld@bcolor]%
      \fi
    >>%
  \fi
  /DA(/Helv \strip@pt\Fld@charsize\space Tf%
      \ifx\Fld@color\@empty\else\space\Fld@color\fi)%
  /DV(\Hy@escapestring{\Fld@default})%
  /V(\Hy@escapestring{\Fld@value})%
  \Fld@additionalactions
  \ifnum\Fld@maxlen>\z@/MaxLen \Fld@maxlen \fi
}
\def\PDFForm@Submit{%
  /Subtype/Widget%
  \Fld@annotflags
  \Fld@pageobjref
  \Fld@annotnames
  /FT/Btn%
  \Fld@flags
  /H/P%
  /BS<</W \Fld@borderwidth/S/\Fld@borderstyle>>%
  \ifcase0\ifnum\Fld@rotation=\z@   \else 1\fi
          \ifx\Fld@bordercolor\relax\else 1\fi
          \space
  \else
    /MK<<%
      \ifnum\Fld@rotation=\z@
      \else
        /R \Fld@rotation
      \fi
      \ifx\Fld@bordercolor\relax
      \else
        /BC[\Fld@bordercolor]%
      \fi
    >>%
  \fi
  /A<<%
    /S/SubmitForm%
    /F<<%
      /FS/URL%
      /F(\Hy@escapestring{\Form@action})%
    >>%
    \Fld@submitflags
  >>%
  \Fld@additionalactions
}
\ifHy@pdfa
\else
  \def\PDFForm@Reset{%
    /Subtype/Widget%
    \Fld@annotflags
    \Fld@pageobjref
    \Fld@annotnames
    /FT/Btn%
    \Fld@flags
    /H/P%
    /DA(/Helv \strip@pt\Fld@charsize\space Tf 0 0 1 rg)%
    \ifcase0\ifnum\Fld@rotation=\z@   \else 1\fi
            \ifx\Fld@bordercolor\relax\else 1\fi
            \space
    \else
      /MK<<%
        \ifnum\Fld@rotation=\z@
        \else
          /R \Fld@rotation
        \fi
        \ifx\Fld@bordercolor\relax
        \else
          /BC[\Fld@bordercolor]%
        \fi
      >>%
    \fi
    /BS<</W \Fld@borderwidth/S/\Fld@borderstyle>>%
    /A<</S/ResetForm>>%
    \Fld@additionalactions
  }%
\fi

% UF: removed Hy@writebookmark
%     \Hy@currentbookmarklevel{0}
%     \Hy@numberline
%     \@@writetorep
%     counter{bookmark@seq@number}
% removed \HyPsd@SanitizeForOutFile, not needed
% removed \currentpdfbookmark, defined by bookmark,
% should use \newcommand there
% removed \subpdfbookmark, defined by bookmark,
% should use \newcommand there
% removed \belowpdfbookmark, defined by bookmark,
% should use \newcommand there
% removed \pdfbookmark, defined by bookmark,
% \BOOKMARK
% \@BOOKMARK
%% \RequirePackage{rerunfilecheck}[2009/12/10]
%% removed \Hy@OutlineRerunCheck, unneeded with bookmark
%% removed \ReadBookmarks / unneeded with bookmark.
%% removed \Hy@OutlineName
%% removed \check@bm@number
%% removed \calc@bm@number

\ifHy@implicit
\else
  \expandafter\endinput
\fi
\newlength\Hy@SectionHShift
\def\Hy@SectionAnchorHref#1{%
  \ifx\protect\@typeset@protect
    \Hy@@SectionAnchor{#1}%
  \fi
}
\DeclareRobustCommand*{\Hy@@SectionAnchor}[1]{%
  \leavevmode
  \hbox to 0pt{%
    \kern-\Hy@SectionHShift
    \Hy@raisedlink{%
      \hyper@anchorstart{#1}\hyper@anchorend
    }%
    \hss
  }%
}
\let\H@old@ssect\@ssect
\def\@ssect#1#2#3#4#5{%
  \Hy@MakeCurrentHrefAuto{section*}%
  \setlength{\Hy@SectionHShift}{#1}%
  \begingroup
    \toks@{\H@old@ssect{#1}{#2}{#3}{#4}}%
    \toks\tw@\expandafter{%
      \expandafter\Hy@SectionAnchorHref\expandafter{\@currentHref}%
      #5%
    }%
  \edef\x{\endgroup
    \the\toks@{\the\toks\tw@}%
  }\x
}
\let\H@old@schapter\@schapter
\def\@schapter#1{%
  \begingroup
    \let\@mkboth\@gobbletwo
    \Hy@MakeCurrentHrefAuto{\Hy@chapapp*}%
    \Hy@raisedlink{%
      \hyper@anchorstart{\@currentHref}\hyper@anchorend
    }%
  \endgroup
  \H@old@schapter{#1}%
}
\ltx@IfUndefined{@chapter}{}{%
  \let\Hy@org@chapter\@chapter
  \def\@chapter{%
    \def\Hy@next{%
      \Hy@MakeCurrentHrefAuto{\Hy@chapapp*}%
      \Hy@raisedlink{%
        \hyper@anchorstart{\@currentHref}\hyper@anchorend
      }%
    }%
    \ifnum\c@secnumdepth>\m@ne
      \ltx@IfUndefined{if@mainmatter}%
      \iftrue{\csname if@mainmatter\endcsname}%
        \let\Hy@next\relax
      \fi
    \fi
    \Hy@next
    \Hy@org@chapter
  }%
}
\let\H@old@part\@part
\begingroup\expandafter\expandafter\expandafter\endgroup
\expandafter\ifx\csname chapter\endcsname\relax
  \let\Hy@secnum@part\z@
\else
  \let\Hy@secnum@part\m@ne
\fi
\def\@part{%
  \ifnum\Hy@secnum@part>\c@secnumdepth
    \phantomsection
  \fi
  \H@old@part
}
\let\H@old@spart\@spart
\def\@spart#1{%
  \Hy@MakeCurrentHrefAuto{part*}%
  \Hy@raisedlink{%
    \hyper@anchorstart{\@currentHref}\hyper@anchorend
  }%
  \H@old@spart{#1}%
}
\let\H@old@sect\@sect
\def\@sect#1#2#3#4#5#6[#7]#8{%
  \ifnum #2>\c@secnumdepth
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi
  {%
    \Hy@MakeCurrentHrefAuto{section*}%
    \setlength{\Hy@SectionHShift}{#3}%
    \begingroup
      \toks@{\H@old@sect{#1}{#2}{#3}{#4}{#5}{#6}[{#7}]}%
      \toks\tw@\expandafter{%
        \expandafter\Hy@SectionAnchorHref\expandafter{\@currentHref}%
        #8%
      }%
    \edef\x{\endgroup
      \the\toks@{\the\toks\tw@}%
    }\x
  }{%
    \H@old@sect{#1}{#2}{#3}{#4}{#5}{#6}[{#7}]{#8}%
  }%
}
\expandafter\def\csname Parent-4\endcsname{}
\expandafter\def\csname Parent-3\endcsname{}
\expandafter\def\csname Parent-2\endcsname{}
\expandafter\def\csname Parent-1\endcsname{}
\expandafter\def\csname Parent0\endcsname{}
\expandafter\def\csname Parent1\endcsname{}
\expandafter\def\csname Parent2\endcsname{}
\expandafter\def\csname Parent3\endcsname{}
\expandafter\def\csname Parent4\endcsname{}

%%
%% End of file `hluatex.def'.
\endinput
%%
%% End of file `hluatex.def'.
