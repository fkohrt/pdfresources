%%
%% This is file `hgeneric-experimental.def',
%% This is an adapted version of hluatex.def
%% meant to test the use of the commands
%% from pdfresources.sty
%%
%% drivers are loaded in line 4745 in hyperref.sty in a \Hy@AtEndOfPackage command.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% list of new internal commands
%% \__hyp_link_begin_goto:nw : start command for links to internal destination
%%                             replaces \find@pdflink
%% \__hyp_pagelabels_gput:n : puts pagelabels in the catalog.
%% \__hyp_pstringdef:Nn     : replaces Hy@pstringdef, converts n to pdfstring and stores in N
%%                            naming??
%% \__hyp_info_generate_addons: what did this do??
%% list of new variables
%% \l__hyp_pdfa_bool : for pdfa option (unclear if it will stay)
%% \l__hyp_pdfstring_tmp_tl
%% \c__hyp_destname_undefined_tl
%% \g__hyp_AcroForm_CoFields_prop
%% \g__hyp_AcroForm_Fields_prop
%% \l__hyp_tmpa_seq
%% \l__hyp_CheckmarkYes_tl
%% \l__hyp_CheckmarkOff_tl
%% \l__hyp_RadioYes_tl
%% list of commands which probably will have to change
%%   \Hy@EXPsetpdfborder
%%   \Hy@EXPsetpdfhighlight
%%   \Hy@EXPsetbordercolor
%%   \hypupdateattribute
\ProvidesFile{hgeneric-experimental.def}
  [2020/03/16 v0.5 %
  Hyperref driver for luaTeX]
\RequirePackage{xparse,etoolbox}
\RequirePackage{pdfresources}
\chardef\Hy@VersionChecked=1 %don't check the version!
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ExplSyntaxOn
%% messages, should later (with more drivers) go somewhere more generic ...
\prop_gput:Nnn \g_msg_module_name_prop { hyp }{ hyperref }
\msg_new:nnn
  { hyp }
  { missing-bookmark-package }
  { The~bookmark~package~is~required~for~this~hyperref~driver! }

\msg_new:nnn
  { hyp }
  { pdfversion-disabled }
  { This~hyperref~driver~ignores~the~pdfversion~key!\\
    Set~the~pdfversion~in~\token_to_str:N \DeclareDocumentMetaData }

\msg_new:nnn
  { hyp }
  { pdfa-no-push-button }
  { PDF/A:~Push~button~with~JavaScript~is~prohibited }

\msg_new:nnn
  { hyp }
  { pdfa-no-reset-button }
  { PDF/A:~Reset~action~is~prohibited }

\msg_new:nnn
  { hyp }
  { empty-destination-name }
  {
    Empty~destination~name,\\
            using~`#1'
  }
%% I require the bookmark package to get rid of some of the bookmarks code.
% but the testing code doesn't work.
% !!!!!!!!!!!!!!!!!!!!! to do !!!!!!!!!!!!!!!!!!!!!
%\Hy@AtEndOfPackage{% so that we are later than KOMA ...
%\AtBeginDocument
% {
%  \ltx@ifpackageloaded{bookmark}
%   {}
%   {\msg_error:nn {hyp}{missing-bookmark-package}}
% }}
% booleans for the (some) option keys. As hyperref disables them it is okay to set them here,
% hypersetup  can't interfere

%%%%%%%%%%%%%%%%
% defaults, will perhaps need some sorting and be checked if they are sensible for all backends
%%%%%%%%%%%%%%%
\providecommand*{\XR@ext}{pdf} %ok as default for all drivers we want to support, should probably go into hyperref
\Hy@setbreaklinks{true}        %also for dvips??

% checked dvips, luatex, xetex, dvipdfm: values are identical:
\providecommand*\@pdfborder{0~0~1}
\providecommand*\@pdfborderstyle{}
% unicode ...
\HyPsd@LoadUnicode
\Hy@unicodetrue
\let\HyPsd@pdfencoding\HyPsd@pdfencoding@unicode

\providecommand*\@pdfview{XYZ}

%%%%%%%%%%
% variants
\cs_generate_variant:Nn \pdf_object_write:nn {nx}
\cs_generate_variant:Nn \pdf_catalog_gput:nn {nx}


%%% pdfa key:
\bool_new:N \l__hyp_pdfa_bool
\ifHy@pdfa
  \bool_set_true:N \l__hyp_pdfa_bool
\fi


% this need sorting out later. pdf standards should be handled outside the driver.
% pdfa forces the flag /F 4 in some places.
\AtBeginDocument
  {
    \bool_if:NT \l__hyp_pdfa_bool
      {
        \hook_put:nnnn
          { pdf }
          { link_begin_url_attr }
          { F }
          { 4 }

        \hook_put:nnnn
          { pdf }
          { link_begin_link_attr }
          { F }
          { 4 }

        \hook_put:nnnn
          { pdf }
          { link_begin_file_attr }
          { F }
          { 4 }

        \hook_put:nnnn
          { pdf }
          { link_begin_menu_attr }
          { F }
          { 4 }
      }
  }

% variants of hyperref commands to get attributes in the prop
% these are (temporary) commands to fill various attributes (color, border style) in
% the hooks for links from the hyperref keys.

% pdfborder, pdfborderstyle

\cs_new_protected:Npn \Hy@EXPsetpdfborder
  {
    \seq_map_inline:Nn \c_pdf_link_types_seq
      {
        \tl_if_empty:NTF \@pdfborder
          {
            \hook_remove:nnn { pdf } { link_begin_##1_attr } { Border }
          }
          {
            \hook_put:nnnn
              { pdf }
              { link_begin_##1_attr }
              { Border }
              { [\@pdfborder] }
          }
        \tl_if_empty:NTF \@pdfborderstyle
          {
            \hook_remove:nnn  { pdf }{ link_begin_##1_attr } { BS }
          }
          {
            \hook_put:nnnn
              { pdf }
              { link_begin_##1_attr }
              { BS }
              { <<\@pdfborderstyle>> }
          }
      }
  }

% highlight
\cs_new_protected:Npn \Hy@EXPsetpdfhighlight
  {
    \seq_map_inline:Nn \c_pdf_link_types_seq
      {
        \tl_if_empty:NTF \@pdfhighlight
          {
            \hook_remove:nnn { pdf } { link_begin_##1_attr }{ H }
          }
          {
            \hook_put:nnnn
              { pdf }
              { link_begin_##1_attr }
              { H }
              { \@pdfhighlight }
         }
     }
  }

% bordercolor
\cs_new_protected:Npn \Hy@EXPsetbordercolor
  {
    \seq_map_inline:Nn \c_pdf_link_types_seq
      {
        \tl_if_exist:cTF { @##1bordercolor }
          {
            \hook_put:nnnn
             { pdf }
             { link_begin_##1_attr }
             { C }
             { [\tl_use:c {@##1bordercolor}] }
          }
          {
            \hook_remove:nnn { pdf } { link_begin_##1_attr } { C }
          }
     }
  }

% for now we are updating the attributes manually after \hypersetup
% some better method must be found
\NewDocumentCommand\hypupdateattribute { }
 {
   \Hy@EXPsetpdfborder
   \Hy@EXPsetpdfhighlight
   \Hy@EXPsetbordercolor
 }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% page labels.
%% current implemention in hyperref/hyperref drivers
% xetex: hxetex line 80-110
%        \HyPL@StorePageLabel writes to the aux-file
%        at begin document (after reading the aux)
%        \HyPL@SetPageLabels is called (defined in hyperref.sty after the driver
%        loading)
%        which calls \Hy@PutCatalog{/PageLabels<</Nums[\HyPL@Labels]>>}%
% dvips  identical to xetex, line 60 to 90 in pdfmark.def
% dvipdfm identical to xetex
% pdftex \HyPL@StorePageLabel stores in \HyPL@Labels in the first compilation
%        \AtVeryEndDocument \HyPL@SetPageLabels is called.
% luatex identical to pdftex
% The code in hyperref inspects \thepage and tries to figure out
% the numbering system and the prefix. E.g. A-\arabic{page} is correctly split.
% If the counter can not be identified hyperref generates only /P entries with the
% whole content.
%% new implementation
% pdftex/luatex
% \AtVeryEndDocument is too late for pdflatex/lualatex the catalog is already pushed
% out. So we update the catalog entry when storing the page label.
% we do not try to avoid the "useless" pagelabel entry /PageLabels <</Nums[0<</S/D>>]>>
% (but it would be possible), we also don't test for empty \thepage, hyperref seems to
% handle this fine and the pdf is valid.

% catalog mapped to expl3 command
% \Hy@PutCatalog is used only in one place but we
% we need this for the dvips/xetex route for the page labels.
% we simply hard code this for now until hyperref.sty itself can be adapted ...
\cs_new:Npn\__hyp_pagelabels_gput:n #1
  {
    \pdf_catalog_gput:nx {PageLabels}{<</Nums[\HyPL@Labels]>>}
  }

\pdf@ifdraftmode %from pdftexcmds replace??
  {
    \let\Hy@PutCatalog \use_none:n
  }
  {
    \let\Hy@PutCatalog \__hyp_pagelabels_gput:n
  }

\legacy_if:nT { Hy@pdfpagelabels }
  {
    \sys_if_output_pdf:TF
      { %pdflatex,lualatex
        \cs_set_protected:Npn \HyPL@StorePageLabel #1
          {
            \tl_gput_right:Nx \HyPL@Labels { \the\Hy@abspage<<#1>> }
            \pdf_catalog_gput:nx { PageLabels }{ <</Nums[\HyPL@Labels]>> }
          }
      }
      { %xetex, dvips, dvipdfmx
        \cs_set_protected:Npn \HyPL@StorePageLabel #1
          {
            \legacy_if:nT { @filesw }
              {
                 \iow_now:Nx\@mainaux
                   {
                      \exp_not:N \HyPL@Entry{\the\Hy@abspage<<#1>>}
                   }
              }
          }
        \Hy@AtBeginDocument
          {
            \legacy_if:nT { @filesw }
              {
                \iow_now:Nn \@mainaux
                   {
                      \providecommand*\HyPL@Entry[1]{}
                   }
              }
            \tl_if_empty:NTF \HyPL@Labels
              {
                \Hy@WarningNoLine{Rerun~to~get~/PageLabels~entry}
              }
              {
                \HyPL@SetPageLabels
              }
              \cs_set_eq:NN \HyPL@Entry \use_none:n
           }
         \cs_set_protected:Npn \HyPL@Entry #1
           {
              \tl_gset:No \HyPL@Labels
                {
                   \HyPL@Labels
                   #1
                }
           }
      }
  }
\ExplSyntaxOff

%UF replace Hy@pstringdef definition.
%% !! check the conversion through the drivers!
\ExplSyntaxOn
\cs_new:Npn \__hyp_pstringdef:Nn #1 #2
  {
    \group_begin:
    \char_set_catcode_other:N \~
    \char_set_active_eq:NN \~ \c_tilde_str
    \char_set_catcode_active:N \~
    \sys_if_engine_pdftex:TF
      { %pdftex. Should we assume utf8 or allow other input encodings?
        \str_gset_convert:Nnnn \g_tmpa_str {#2}{utf8}{utf8/string} %utf8 because of hyperref
      }
      { %luatex,xetex
        \str_gset_convert:Nnnn \g_tmpa_str {#2}{}{utf8/string} %utf8 because of hyperref
      }
    \group_end:
    \str_set_eq:NN#1 \g_tmpa_str
  }
\cs_generate_variant:Nn \__hyp_pstringdef:Nn {No,Nx}
\cs_set_eq:NN\Hy@pstringdef \__hyp_pstringdef:Nx
\ExplSyntaxOff


\ExplSyntaxOn
%these patterns are used in hyperref checks.
%it is unclear if they are really useful and if a backend support is
%needed.
\str_case:VnF \c_sys_backend_str
 {
   { pdfmode }
   {
     \def\HyPat@ObjRef
      {
       [0-9]*[1-9][0-9]*~0~R
      }
   }
   { dvipdfmx }
   {
     \def\HyPat@ObjRef
      {
        @[^~]+
      }
   }
   { xdvipdfmx }
   {
     \def\HyPat@ObjRef
      {
        @[^~]+
      }
   }
 }
 { %also set in hyperref sty, so probably not needed.
   \def\HyPat@ObjRef/{.+}
 }

%we force the setting of pdfversion in \DeclareDocumentMetaData
\cs_set_eq:NN \Hy@pdfminorversion \pdf_version_minor:
\cs_set_eq:NN \Hy@pdfmajorversion \pdf_version_major:

\legacy_if:nT { Hy@ocgcolorlinks }
  {
    \pdf_version_min_gset:n { 1.5 }
  }

\legacy_if:nT { Hy@setpdfversion }
 {
    \msg_warning:nn { hyp }{ pdfversion-disabled }
 }


\Hy@DisableOption{pdfversion}%

% ocg colorlinks should be done as in ocgx. This here
% are boxes ...
\legacy_if:nTF {Hy@ocgcolorlinks}
  {
    \newcommand\OBJ@OCG@view {} % for the hyperref test
    \pdf@ifdraftmode
      {}
      {
        \pdf_object_new:nn   { l__hyp_ocg_view_dict_obj }   { dict }
        \pdf_object_new:nn   { l__hyp_ocg_print_dict_obj }  { dict }
        \pdf_object_new:nn   { l__hyp_ocg_config_dict_obj } { dict }
        \pdf_object_new:nn   { l__hyp_ocg_ref_array_obj }   { array }
        \pdf_object_write:nx { l__hyp_ocg_ref_array_obj }
          {
            \pdf_object_ref:n { l__hyp_ocg_view_dict_obj }
            \c_space_tl
            \pdf_object_ref:n { l__hyp_ocg_print_dict_obj }
          }
        \pdf_object_write:nn { l__hyp_ocg_view_dict_obj }
          {
            /Type/OCG
            /Name(View)
            /Usage
             <<
              /Print <</PrintState/OFF>>~
              /View  <</ViewState/ON  >>~
             >>
          }
        \pdf_object_write:nn { l__hyp_ocg_print_dict_obj }
          {
            /Type/OCG
            /Name(Print)
            /Usage
             <<
              /Print <</PrintState/ON>>~
              /View  <</ViewState/OFF>>~
             >>
          }
       \pdf_catalog_gput:nn { OCProperties/OCGs }{ l__hyp_ocg_view_dict_obj }
       \pdf_catalog_gput:nn { OCProperties/OCGs }{ l__hyp_ocg_print_dict_obj }
       \pdf_object_write:nx { l__hyp_ocg_config_dict_obj }
         {
           /OFF[\pdf_object_ref:n { l__hyp_ocg_print_dict_obj }]
           /AS[
             <<
              /Event/View
              /OCGs\c_space_tl \pdf_object_ref:n { l__hyp_ocg_ref_array_obj }
              /Category[/View]
             >>
             <<
              /Event/Print
              /OCGs\c_space_tl \pdf_object_ref:n { l__hyp_ocg_ref_array_obj }
              /Category[/Print]
             >>
             <<
              /Event/Export
              /OCGs\c_space_tl \pdf_object_ref:n { l__hyp_ocg_ref_array_obj }
              /Category[/Print]
             >>
              ]
         }
       \pdf_catalog_gput:nn { OCProperties/D }{ l__hyp_ocg_config_dict_obj }
    }
    \Hy@AtBeginDocument
      {
        \def\Hy@colorlink#1
          {
            \group_begin:
            \legacy_if:nTF {Hy@ocgcolorlinks}
              {
                \def\Hy@ocgcolor{#1}
                \setbox0=\hbox\bgroup\color@begingroup
              }
              {
                \HyColor@UseColor#1
              }
          }
        \def\Hy@endcolorlink
         {
           \legacy_if:nT {Hy@ocgcolorlinks}
             {
               \color@endgroup\egroup
               \mbox
                 {
                   \pdf_bdc:nn {OC}{l__hyp_ocg_print_dict_obj}
                   \rlap{\copy0}
                   \pdf_emc:
                   \pdf_bdc:nn {OC}{l__hyp_ocg_view_dict_obj}
                   \group_begin:
                   \expandafter\HyColor@UseColor\Hy@ocgcolor
                   \box0~
                   \group_end:
                   \pdf_emc:
                }
             }
           \group_end:
         }
      }
   }
   {
     \Hy@DisableOption{ocgcolorlinks}
   }

\cs_set_protected:Npn \setpdflinkmargin #1
  {
    \pdf_link_margin:n { #1 }
  }

% default:
\pdf_link_margin:n { 1pt }

\ExplSyntaxOff

\ExplSyntaxOn
\newcommand\Hy@pstringDest{}
\tl_new:N \l__hyp_pdfstring_tmp_tl

\Hy@WrapperDef\new@pdflink#1 % #1 is a destination name.
  {
    \mode_if_horizontal:T { \@savsf\spacefactor }
    \Hy@SaveLastskip      %defined in hyperref
    \Hy@VerboseAnchor{#1} %defined in hyperref, for debugging
    \__hyp_pstringdef:Nx  \l__hyp_pdfstring_tmp_tl { \HyperDestNameFilter{#1} } %
    \exp_args:NV \pdf_destination:nf { \l__hyp_pdfstring_tmp_tl } { \@pdfview } %
    \Hy@RestoreLastskip   %defined in hyperref
    \mode_if_horizontal:T { \spacefactor\@savsf }
  }
\let\pdf@endanchor\@empty

\ExplSyntaxOff
\ExplSyntaxOn

%\cs_new_protected:Npn \Hy@DestName #1 #2 % #1= name #2= fit options
%  {
%    \pdf_destination:nf {#1}{#2}
%  }

%\ExplSyntaxOff
\tl_const:Nn \c__hyp_destname_undefined_tl {UNDEFINED}
\tl_new:N \l__hyp_destname_tmpa_tl

%\def\find@pdflink#1#2
\cs_new_protected:Npn \__hyp_link_begin_goto:nw #1
  {
    \mode_leave_vertical:
    \protected@edef\l__hyp_destname_tmpa_tl { #1 }
    \tl_if_empty:NTF \l__hyp_destname_tmpa_tl
      {
        \msg_warning:nnx { hyp } { empty-destination-name } { \c__hyp_destname_undefined_tl }
        \tl_set_eq:NN \l__hyp_destname_tmpa_tl \c__hyp_destname_undefined_tl
      }
      { %I hope this is right ...
        \__hyp_pstringdef:Nx \l__hyp_destname_tmpa_tl
          {
            \exp_args:No \HyperDestNameFilter { \l__hyp_destname_tmpa_tl }
          }
    %\Hy@pstringdef\Hy@testname{%
    %  \expandafter\HyperDestNameFilter\expandafter{\Hy@testname}%
    %}%
     }
     \exp_args:Nno
       \pdf_link_begin_goto:nnw { link } { \l__hyp_destname_tmpa_tl }
         \Hy@colorlink\@linkcolor
  }

\ExplSyntaxOn

%experiment end link code
\cs_new_protected:Npn \close@EXPpdflink #1
  {
    \Hy@endcolorlink
    \Hy@VerboseLinkStop
    \pdf_link_end:n { #1 }
  }


\ExplSyntaxOff

\def\hyper@anchor#1{%
  \new@pdflink{#1}\anchor@spot\pdf@endanchor
}

\def\hyper@anchorstart#1{%
  \new@pdflink{#1}%
  \Hy@activeanchortrue
}

\def\hyper@anchorend{%
  \pdf@endanchor
  \Hy@activeanchorfalse
}

\ExplSyntaxOn
% hyper@linkstart/ \hyper@linkend is used for
% footnotemarks, toc and natbib-cites
% #1 is for the color only: found {cite} and {link}
% #2 is the destination find@pdflink uses then named link

\cs_new_protected:Npn \hyper@linkstart #1 #2
  {
    \Hy@VerboseLinkStart{#1}{#2}% only for debug
    \__hyp_link_begin_goto:nw {#2}% #1=color type (fix), #2=destination name
  }

% the endlink muss have the same type as the start?
% probably always link works ? But what is with my hooks???
\cs_new_protected:Npn \hyper@linkend
  {
    \close@EXPpdflink { link }
  }

\def\hyper@link#1#2#3
 {
  \Hy@VerboseLinkStart{#1}{#2}
  \__hyp_link_begin_goto:nw {#2}#3\Hy@xspace@end
  \close@EXPpdflink { link }
}
\ExplSyntaxOff

\let\CurrentBorderColor\@linkbordercolor
\ExplSyntaxOn
%% this command is used for \url
\def\hyper@linkurl#1#2{%#1:link text #2: URI,
  \group_begin:
    \Hy@pstringdef\Hy@pstringURI{#2}%
    \hyper@chars
    \mode_leave_vertical:
    \pdf_link_user:nnn { url }
     {
       /Subtype /Link
       /A<<
         /Type/Action~
         /S/URI~
         /URI(\Hy@pstringURI)~
         \ifHy@href@ismap
           /IsMap~true~
         \fi
         \Hy@href@nextactionraw
       >>
    }
    {
     \Hy@colorlink
     \@urlcolor#1\Hy@xspace@end
     \Hy@endcolorlink
     \Hy@VerboseLinkStop
    }
  \group_end:
}
\ExplSyntaxOff

\ExplSyntaxOn
%file links (need to find out when exactly it is used ...)
\def\hyper@linkfile#1#2#3{% anchor text, filename, linkname
  \group_begin:
    \def\Hy@pstringF{#2}%
    \Hy@CleanupFile\Hy@pstringF
    \Hy@pstringdef\Hy@pstringF\Hy@pstringF
    \Hy@pstringdef\Hy@pstringD{#3}
    \Hy@MakeRemoteAction
    \mode_leave_vertical:
    \pdf_link_user:nnn
     { file }
     {
       /Subtype /Link
       /A<<
          /F(\Hy@pstringF)
          /S/GoToR
          \Hy@SetNewWindow
          \ifx\\#3\\
            /D[\Hy@href@page\@pdfremotestartview]
          \else
            /D(\Hy@pstringD)
          \fi
          \Hy@href@nextactionraw
        >>
     }
     {
       \Hy@colorlink
        \@filecolor#1\Hy@xspace@end
       \Hy@endcolorlink
       \Hy@VerboseLinkStop
     }
  \group_end:
}
\ExplSyntaxOff

\ExplSyntaxOn
% use by run links xxxxxxxxxxx
\use:x
  { % filename, anchor text, linkname
    \cs_set_protected:Npn \exp_not:N \@hyper@launch run \c_colon_str ##1 \exp_not:N \\ ##2 ##3
  }
%\def\@hyper@launch run:#1\\#2#3 % filename, anchor text linkname
 {
  \group_begin:
    \Hy@pstringdef\Hy@pstringF{#1}%
    \Hy@pstringdef\Hy@pstringP{#3}%
    \mode_leave_vertical:
    \pdf_link_user:nnn
     { run }
     {
      /Subtype /Link
      /A<<
          /F(\Hy@pstringF)
          /S/Launch
          \Hy@SetNewWindow
          \ifx\\#3\\
          \else
            /Win<</P(\Hy@pstringP)/F(\Hy@pstringF)>>
          \fi
          \Hy@href@nextactionraw
        >>
      }
      {
       \Hy@colorlink
        \@runcolor#2\Hy@xspace@end
       \Hy@endcolorlink
       \Hy@VerboseLinkStop
      }
  \group_end:
}


%this needs central management in the kernel
\def\PDF@SetupDoc{
  \tl_if_empty:NF\@pdfpagescrop
  {
   \pdf_pagesattr_gput:nn { CropBox } { [\@pdfpagescrop] }
  }
  \pdf_catalog_gput:nx { PageMode }{ /\@pdfpagemode }
  \tl_if_empty:NF \@baseurl
   {
    \Hy@pstringdef\Hy@pstringB{\@baseurl}%
    \pdf_catalog_gput:nn { URI }{ <</Base(\Hy@pstringB)>> }
   }
  \tl_if_empty:oF { \@pdfpagelayout }
   {
    \pdf_catalog_gput:nx{ PageLayout }{ /\@pdfpagelayout }
   }
  \tl_if_exist:NT\@pdflang
   {
    \tl_if_empty:NF\@pdflang
    {
     \pdf_catalog_gput:nx { Lang } { (\@pdflang) }
    }
   }
  \bool_if:nF
   {
    \tl_if_empty_p:N \@pdfstartpage
    ||
    \tl_if_empty_p:N \@pdfstartview
   }
   {
     \exp_args:Noo
     \pdf_docview:nn {\@pdfstartpage} {\tl_tail:N\@pdfstartview}
   }
    \ifHy@pdftoolbar\else
     \pdf_catalog_gput:nn { ViewerPreferences } {{ HideToolbar } { true }}
    \fi
    \ifHy@pdfmenubar\else
     \pdf_catalog_gput:nn { ViewerPreferences } {{ HideMenubar } { true }}
    \fi
    \ifHy@pdfwindowui\else
     \pdf_catalog_gput:nn {ViewerPreferences} {{ HideWindowUI } { true }}
    \fi
    \ifHy@pdffitwindow
     \pdf_catalog_gput:nn { ViewerPreferences} {{ FitWindow } { true }}
    \fi
    \ifHy@pdfcenterwindow
     \pdf_catalog_gput:nn { ViewerPreferences } {{ CenterWindow } { true }}
    \fi
    \ifHy@pdfdisplaydoctitle
     \pdf_catalog_gput:nn { ViewerPreferences } {{ DisplayDocTitle } { true }}
    \fi
    \tl_if_empty:NF  \@pdfnonfullscreenpagemode
    {
     \pdf_catalog_gput:nx { ViewerPreferences } {{ NonFullScreenPageMode } { /\@pdfnonfullscreenpagemode }}
    }
    \tl_if_empty:NF  \@pdfdirection
    {
     \pdf_catalog_gput:nx { ViewerPreferences } {{ Direction } { /\@pdfdirection }}
    }
    \tl_if_empty:NF  \@pdfviewarea
    {
     \pdf_catalog_gput:nx { ViewerPreferences } {{ ViewArea }{/\@pdfviewarea }}
    }
    \tl_if_empty:NF  \@pdfviewclip
    {
     \pdf_catalog_gput:nx { ViewerPreferences } {{ ViewClip } { /\@pdfviewclip }}
    }
    \tl_if_empty:NF  \@pdfprintarea
    {
     \pdf_catalog_gput:nx { ViewerPreferences }{{ PrintArea } { /\@pdfprintarea }}
    }
    \tl_if_empty:NF  \@pdfprintclip
    {
     \pdf_catalog_gput:nx { ViewerPreferences }{{ PrintClip } { /\@pdfprintclip }}
    }
    \tl_if_empty:NF  \@pdfprintscaling
    {
     \pdf_catalog_gput:nx { ViewerPreferences } {{ PrintScaling } { /\@pdfprintscaling }}
    }
    \tl_if_empty:NF  \@pdfduplex
    {
     \pdf_catalog_gput:nx { ViewerPreferences } {{ Duplex } { /\@pdfduplex }}
    }
    \tl_if_empty:NF \@pdfpicktraybypdfsize
    {
     \pdf_catalog_gput:nx{ ViewerPreferences } {{ PickTrayByPDFSize } { \@pdfpicktraybypdfsize }}
    }
    \tl_if_empty:NF \@pdfprintpagerange
    {
     \pdf_catalog_gput:nx { ViewerPreferences } {{ PrintPageRange } {  [ \@pdfprintpagerange ] }}
    }
    \tl_if_empty:NF  \@pdfnumcopies
    {
     \pdf_catalog_gput:nx { ViewerPreferences } {{ NumCopies } {  \@pdfnumcopies }}
    }
}


\cs_new:Npn \__hyp_info_generate_addons:
 {
    \group_begin:
      \cs_set:Npn \HyInfo@do##1{%
        \EdefEscapeName\HyInfo@Key{##1}%
        \pdf_info_gput:on {\HyInfo@Key}{(\csname HyInfo@Value@##1\endcsname)}
        }
      \HyInfo@AddonList
    \group_end:
 }


\def\PDF@FinishDoc{}% dummy needed for hyperref ...

\AtEndPreamble{
  \pdf@ifdraftmode{}{
    \Hy@UseMaketitleInfos %get Title/Author from \title if pdfusetitle is true
    \__hyp_info_generate_addons:
    \pdf_info_string_gput:no
      {Author} {\@pdfauthor}
    \pdf_info_string_gput:no
      {Title}  {\@pdftitle}
    \pdf_info_string_gput:no
      {Subject}{\@pdfsubject}
    \pdf_info_string_gput:no
      {Creator}{\@pdfcreator}
    \pdf_info_string_gput:no
      {CreationDate}{\@pdfcreationdate}
    \pdf_info_string_gput:no
      {ModDate}{\@pdfmoddate}
    \tl_if_exist:NT \@pdfproducer %special, as \relax is default
      {
       \pdf_info_string_gput:no
        {Producer}{\@pdfproducer}
      }
    \pdf_info_string_gput:no
      {Keywords}{\@pdfkeywords}
    \tl_if_empty:NF
       \@pdftrapped
       {
        \pdf_info_gput:nn
        {Trapped}{/\@pdftrapped}
       }
    }
  \Hy@DisableOption{pdfauthor}%
  \Hy@DisableOption{pdftitle}%
  \Hy@DisableOption{pdfsubject}%
  \Hy@DisableOption{pdfcreator}%
  \Hy@DisableOption{pdfcreationdate}%
  \Hy@DisableOption{pdfmoddate}%
  \Hy@DisableOption{pdfproducer}%
  \Hy@DisableOption{pdfkeywords}%
  \Hy@DisableOption{pdftrapped}%
  \Hy@DisableOption{pdfinfo}%
}

\def\hyper@pagetransition{%
  \ifx\@pdfpagetransition\relax
  \else
   \pdf_pageattr_gremove:n {Trans}
   \tl_if_empty:NF \@pdfpagetransition
    {
     \pdf_pageattr_gput:nn {Trans}{<< /S /\@pdfpagetransition\space >>}
    }
  \fi
}

\def\hyper@pageduration{%
  \ifx\@pdfpageduration\relax
  \else
   \pdf_pageattr_gremove:n {Dur}
   \tl_if_empty:NF \@pdfpageduration
    {
     \pdf_pageattr_gput:nn {Dur}{\@pdfpageduration\space}
    }
  \fi
}
\ExplSyntaxOff


\pdf@ifdraftmode{}{%
  \g@addto@macro\Hy@EveryPageHook{%
    \hyper@pagetransition
    \hyper@pageduration
    %\hyper@pagehidden %UF is obsolete
  }%
}

%%% UF removed setpagesize code, should be done by kernel/graphicx
\ExplSyntaxOn
\def\Acrobatmenu#1#2{%
  \Hy@Acrobatmenu{#1}{#2}{%
    \mode_leave_vertical:
    \EdefEscapeName\Hy@temp@menu{#1}%
    \pdf_link_user:nnn { menu }
      {
       /Subtype /Link
       /A<<
          /S/Named
          /N/\Hy@temp@menu
          \Hy@href@nextactionraw
        >>

      }
      {
       \Hy@colorlink\@menucolor#2
       \Hy@xspace@end
       \Hy@endcolorlink
       \Hy@VerboseLinkStop
      }
  }
}
\ExplSyntaxOff
%%% UF removed old atbegshi fix
\ExplSyntaxOn
\def\MakeFieldObject#1#2
  {
    \pdf_xform_new:nnn { #2 }{} { #1 }
  }%

\prop_new:N   \g__hyp_AcroForm_CoFields_prop
\prop_new:N   \g__hyp_AcroForm_Fields_prop
\seq_new:N    \l__hyp_tmpa_seq
\let\HyField@afields\ltx@empty
\let\HyField@cofields\ltx@empty
%% UF test for old pdftex removed
%\let\HyField@AuxAddToFields\ltx@gobble
%\let\HyField@AuxAddToCoFields\ltx@gobbletwo
\def\HyField@AfterAuxOpen{\Hy@AtBeginDocument}%

% the value doesn't matter, but with a prop we avoid duplicates and it is
% clearly faster than removing them from a sequence
\def\HyField@AuxAddToFields#1
  {
    \prop_gput:Nnn \g__hyp_AcroForm_Fields_prop {#1}{F}
  }%

%fields with empty key get a value too -- lets hope that
%this give the expected behaviour
\def\HyField@AuxAddToCoFields #1 #2
  {
    \prop_gput:Nnn \g__hyp_AcroForm_CoFields_prop {a#1}{#2}
  }

\Hy@AtBeginDocument
  {
    \if@filesw
      \immediate\write\@mainaux{%
        \string\providecommand\string\HyField@AuxAddToFields[1]{}%
       }%
      \immediate\write\@mainaux{%
        \string\providecommand\string\HyField@AuxAddToCoFields[2]{}%
      }%
    \fi
    \let\HyField@AfterAuxOpen\@firstofone
  }%

\def\HyField@AddToFields
  {
    \exp_args:Nx\HyField@@AddToFields
      {
        %\pdf_link_last:
        \pdf_annotation_last:
      }
    \ifx\Fld@calculate@code\ltx@empty
    \else
      \begingroup
        \Hy@safe@activestrue
        \edef\Hy@temp{%
          \endgroup
          \if@filesw
            \write\@mainaux
             {
              \string\HyField@AuxAddToCoFields
               {
                \Fld@calculate@sortkey
               }
               {
                 %  \pdf_link_last:
                 \pdf_annotation_last:
               }
            }
          \fi
        }%
      \Hy@temp
    \fi
  }%

\def\HyField@@AddToFields#1{
  \HyField@AfterAuxOpen{%
    \if@filesw
      \write\@mainaux{%
        \string\HyField@AuxAddToFields{#1}%
        }%
      \fi
    }%
  }%

\ExplSyntaxOff
\ExplSyntaxOn
\tl_new:N  \l__hyp_CheckmarkYes_tl
\tl_set:Nn \l__hyp_CheckmarkYes_tl {  __hyp_xform_CheckMarkYes }
\tl_new:N  \l__hyp_CheckmarkOff_tl
\tl_set:Nn \l__hyp_CheckmarkOff_tl {  __hyp_xform_CheckMarkOff }

\def\@Form[#1]
  {
    \@ifundefined{textcolor}{\let\textcolor\@gobble}{}
    \kvsetkeys{Form}{#1}
    \pdf@ifdraftmode{}
      {
        \Hy@FormObjects
        \prop_map_inline:Nn \g__hyp_AcroForm_Fields_prop
          {
            \pdf_catalog_gput:nn {AcroForm/Fields}{##1}
          }
        \prop_if_empty:NF \g__hyp_AcroForm_CoFields_prop
          {
            \prop_map_inline:Nn \g__hyp_AcroForm_CoFields_prop
              {
                \seq_put_right:Nn \l__hyp_tmpa_seq {##1}
              }
            \seq_sort:Nn \l__hyp_tmpa_seq
              {
                \int_compare:nNnTF { \pdf@strcmp{##1}{##2} } > { 0 }
                %\int_compare:nNnTF { \__str_if_eq:nn {#1}{#2} } > { 0 }
                  { \sort_return_swapped: }
                  { \sort_return_same: }
              }
            \seq_map_inline:Nn \l__hyp_tmpa_seq
             {
                \pdf_catalog_gput:nx
                  {AcroForm/CO}
                  {
                    \prop_item:Nn \g__hyp_AcroForm_CoFields_prop {##1}
                  }
             }
          }
       \pdf_catalog_gput:nx
         { AcroForm/DR/Font }
         { {ZaDb} {\pdf_object_ref:n {l__hyp_font_zapfdingbats_obj} } }
       \pdf_catalog_gput:nx
         { AcroForm/DR/Font }
         { {Helv} {\pdf_object_ref:n {l__hyp_font_helvetica_obj} } }
       \pdf_catalog_gput:nn {AcroForm}{{DA}{(/Helv~10~Tf~0~g)}}
       \legacy_if:nF { Hy@pdfa } %?????? Standards?
         {
           \legacy_if:nT { HyField@NeedAppearances }
             {
               \pdf_catalog_gput:nn {AcroForm}{{NeedAppearances}{true}}
             }
         }
       }
     \MakeFieldObject
       {
         \group_begin:
         \fontfamily{pzd}
         \fontencoding{U}
         \fontseries{m}
         \fontshape{n}
         \selectfont
         \char123
         \group_end:
       }
       {__hyp_xform_Ding}
    \MakeFieldObject
       {
         \group_begin:
         \fontfamily{pzd}
         \fontencoding{U}
         \fontseries{m}
         \fontshape{n}
         \selectfont
         \phantom{\char123}
         \group_end:
       }
       {__hyp_xform_DingOff}
     \MakeFieldObject
       {
         \group_begin:
         \fontfamily{pzd}
         \fontencoding{U}
         \fontseries{m}
         \fontshape{n}
         \selectfont
         \char51
         \group_end:
       }
       {__hyp_xform_CheckMarkYes}
     \MakeFieldObject
       {
        \group_begin:
         \fontfamily{pzd}
         \fontencoding{U}
         \fontseries{m}
         \fontshape{n}
         \selectfont
         \phantom{\char51} %perhaps xetex needs some small glyph ..
         \group_end:
       }
       {__hyp_xform_CheckMarkOff}
     \MakeFieldObject
       {
         \fbox{\textcolor{yellow}{\textsf{Submit}}} %color?
       }
       {__hyp_xform_Submit}
     \MakeFieldObject
       {
         \fbox{\textcolor{yellow}{\textsf{SubmitP}}} %color?
       }
       {__hyp_xform_SubmitP}
  }
\ExplSyntaxOff
\let\@endForm\ltx@empty
\let\HyAnn@AbsPageLabel\ltx@empty
\let\Fld@pageobjref\ltx@empty

\ExplSyntaxOn
\newcount\HyAnn@Count
\HyAnn@Count=\ltx@zero
\def\HyAnn@AbsPageLabel
  {
    \global\advance\HyAnn@Count by\ltx@one
    %\zref@labelbyprops{HyAnn@\the\HyAnn@Count}{abspage}%
    \zref@labelbylist {HyAnn@\the\HyAnn@Count} {l3pdf}
    \zref@refused{HyAnn@\the\HyAnn@Count}%
  }%
\def\Fld@pageobjref
  {
    \zref@ifrefundefined{HyAnn@\the\HyAnn@Count}
      {}
      {
        \zref@ifrefcontainsprop{HyAnn@\the\HyAnn@Count}{pdf@abspage}
          {
            /P~\pdf_pageobject_ref:n
                 {
                   \zref@extractdefault{HyAnn@\the\HyAnn@Count}{pdf@abspage}{1} %
                 }
          }
          {}
       }
  }

\ExplSyntaxOff
\ExplSyntaxOn
%% check if the attr should be set through
%% hooks.
%% check if options are missing.
\def\@TextField[#1]#2{% parameters, label
  \def\Fld@name{#2}%
  \let\Fld@default\ltx@empty
  \let\Fld@value\@empty
  \def\Fld@width{\DefaultWidthofText}%
  \def\Fld@height{%
    \ifFld@multiline
      \DefaultHeightofTextMultiline
    \else
      \DefaultHeightofText
    \fi
  }%
  \begingroup
    \expandafter\HyField@SetKeys\expandafter{%
      \DefaultOptionsofText,#1%
    }%
    \PDFForm@Name
    \HyField@FlagsText
    \ifFld@hidden\def\Fld@width{1sp}\fi
    \ifx\Fld@value\@empty\def\Fld@value{\Fld@default}\fi
    \LayoutTextField{#2}{%
      \leavevmode
      \HyAnn@AbsPageLabel
      \Hy@escapeform\PDFForm@Text
      \pdf_annotation:nnnn
          {\Fld@width}
          {\Fld@height}
          {0pt} %is this correct?
          {\PDFForm@Text}
      \MakeTextField{\Fld@width}{\Fld@height}
      \HyField@AddToFields
    }%
  \endgroup
}
\providecommand\@curropt{}
\def\@ChoiceMenu[#1]#2#3{% parameters, label, choices
  \def\Fld@name{#2}
  \let\Fld@default\relax
  \let\Fld@value\relax
  \def\Fld@width{\DefaultWidthofChoiceMenu}
  \def\Fld@height{\DefaultHeightofChoiceMenu}
  \begingroup
    \Fld@menulength=0 %
    \@tempdima\z@
    \clist_map_variable:nNn { #3 } \@curropt
    %\@for\@curropt:=#3\do
      {%
        \expandafter\Fld@checkequals\@curropt==\\%
        \Hy@StepCount\Fld@menulength
        \settowidth{\@tempdimb}{\@currDisplay}%
        \ifdim\@tempdimb>\@tempdima\@tempdima\@tempdimb\fi
      }%
    \advance\@tempdima by~15\p@
    \begingroup
      \HyField@SetKeys{#1}
    \edef\x{\endgroup
      \noexpand\expandafter
      \noexpand\HyField@SetKeys
      \noexpand\expandafter{%
        \expandafter\noexpand\csname DefaultOptionsof%
          \ifFld@radio
            Radio%
          \else
            \ifFld@combo
              \ifFld@popdown
                PopdownBox%
              \else
                ComboBox%
              \fi
            \else
              ListBox%
            \fi
          \fi
        \endcsname
      }%
    }\x
    \HyField@SetKeys{#1}%
    \PDFForm@Name
    \ifFld@hidden\def\Fld@width{1sp}\fi
    \ifx\Fld@value\relax
      \let\Fld@value\Fld@default
    \fi
    \LayoutChoiceField{#2}{%
      \ifFld@radio
        \HyField@FlagsRadioButton
        \@@Radio{#3}%
      \else
        \begingroup
          \HyField@FlagsChoice
          \ifdim\Fld@width<\@tempdima
            \ifdim\@tempdima<1cm\@tempdima1cm\fi
            \edef\Fld@width{\the\@tempdima}%
          \fi
          \ifFld@combo
          \else
            \@tempdima=\the\Fld@menulength\Fld@charsize
            \advance\@tempdima by~\Fld@borderwidth bp %
            \advance\@tempdima by~\Fld@borderwidth bp %
            \edef\Fld@height{\the\@tempdima}%
          \fi
          \@@Listbox{#3}%
        \endgroup
      \fi
    }%
  \endgroup
}
\tl_new:N  \l__hyp_RadioYes_tl
\tl_set:Nn \l__hyp_RadioYes_tl { __hyp_xform_Ding }
\def\@@Radio#1{%
  \Fld@listcount=0~%
  %\show\Fld@default
  \EdefEscapeName\Fld@default{\Fld@default}%
  \clist_map_variable:nNn { #1 } \@curropt
  %\@for\@curropt:=#1\do
   {%
    \expandafter\Fld@checkequals\@curropt==\\%
    \EdefEscapeName\@currValue{\@currValue}%
    \Hy@StepCount\Fld@listcount
    \@currDisplay\space
    \leavevmode
    \HyAnn@AbsPageLabel
    \Hy@escapeform\PDFForm@Radio
    \pdf_annotation:nnnn
      {\Fld@width}
      {\Fld@height}
      {0pt} %is this correct?
      {
        \PDFForm@Radio
        /AP
         <<
         /N
          <<
          /\@currValue\c_space_tl \pdf_xform_ref:o {__hyp_xform_Ding}
          %/Off \c_space_tl \pdf_xform_ref:n {__hyp_xform_DingOff} %hm
          >>
         >>
      }
      {\fbox{  \MakeRadioField{\Fld@width}{\Fld@height}} }
     \int_compare:nNnT { \Fld@listcount} = { 1 }
      { \HyField@AddToFields }
    \c_space_tl % deliberate space between radio buttons
                % to do: --> should be configurable
  }%
}

\newcount\Fld@listcount
\def\@@Listbox#1
 {
  \HyField@PDFChoices{#1}
  \mode_leave_vertical:
  \HyAnn@AbsPageLabel
  \Hy@escapeform\PDFForm@List
  \pdf_link_user:nnn
       {widget} %perhaps we need more types??
       {\PDFForm@List}
       {\MakeChoiceField{\Fld@width}{\Fld@height}}
  \HyField@AddToFields
 }


\def\@PushButton[#1]#2{% parameters, label
  \def\Fld@name{#2}%
  \group_begin:
    \exp_args:No\HyField@SetKeys
     {
      \DefaultOptionsofPushButton,#1
     }
    \PDFForm@Name
    \bool_if:NTF \l__hyp_pdfa_bool
     {
      \msg_error:nn { hyp }{ pdfa-no-push-button }
       \LayoutPushButtonField
        {
         \mode_leave_vertical:
         \MakeButtonField{#2}
        }
     }
     {
      \HyField@FlagsPushButton
      \legacy_if:nT {Fld@hidden}
        {
          \def\Fld@width{1sp}
        }
      \LayoutPushButtonField
       {
        \mode_leave_vertical:
        \HyAnn@AbsPageLabel
        \Hy@escapeform\PDFForm@Push
        \hbox_set:Nn \l_tmpa_box { \MakeButtonField {#2}}
        \pdf_annotation:nnnn
          {\box_wd:N\l_tmpa_box}
          {\box_ht:N\l_tmpa_box}
          {\box_dp:N\l_tmpa_box} %is this correct?
          {\PDFForm@Push}
         {\box_use:N\l_tmpa_box}
        \HyField@AddToFields
       }
      }
  \group_end:
}

\def\@Submit[#1]#2
 {
   \def\Fld@width {\DefaultWidthofSubmit}
   \def\Fld@height{\DefaultHeightofSubmit}
   \group_begin:
     \exp_args:No\HyField@SetKeys
       {
         \DefaultOptionsofSubmit,#1
       }
   \HyField@FlagsPushButton
   \HyField@FlagsSubmit
   \legacy_if:nT { Fld@hidden }
     {
       \def\Fld@width{1sp}
     }
    \mode_leave_vertical:
    \HyAnn@AbsPageLabel
    \Hy@escapeform\PDFForm@Submit
    \hbox_set:Nn \l_tmpa_box { \MakeButtonField {#2}}
    \pdf_annotation:nnnn
      {\box_wd:N\l_tmpa_box}
      {\box_ht:N\l_tmpa_box}
      {\box_dp:N\l_tmpa_box} %is this correct?
      {
        \PDFForm@Submit
        /AP<<
          /N~\pdf_xform_ref:n {__hyp_xform_Submit}~
          /D~\pdf_xform_ref:n {__hyp_xform_SubmitP}
         >>
       }
      \HyField@AddToFields
      \box_use:N\l_tmpa_box

    \group_end:
 }

\def\@Reset[#1]#2
 {
   \def\Fld@width {\DefaultWidthofReset}
   \def\Fld@height{\DefaultHeightofReset}
   \group_begin:
     \exp_args:No\HyField@SetKeys
       {
         \DefaultOptionsofReset,#1
       }
     \mode_leave_vertical:
     \bool_if:NTF \l__hyp_pdfa_bool
       {
         \msg_error:nn { hyp }{ pdfa-no-reset-button }
         \MakeButtonField{#2}
       }
       {
         \HyField@FlagsPushButton
         \legacy_if:nT { Fld@hidden }
           { \def\Fld@width{1sp} }
         \HyAnn@AbsPageLabel
         \Hy@escapeform\PDFForm@Reset
         \hbox_set:Nn \l_tmpa_box { \MakeButtonField {#2}}
         \pdf_annotation:nnnn
           {\box_wd:N\l_tmpa_box}
           {\box_ht:N\l_tmpa_box}
           {\box_dp:N\l_tmpa_box} %is this correct?
           { \PDFForm@Reset }
         \HyField@AddToFields
         \box_use:N \l_tmpa_box
       }
    \group_end:
  }

\def\@CheckBox[#1]#2
  {% parameters, label
    \def\Fld@name{#2}
    \def\Fld@default{0}
    \group_begin:
      \def\Fld@width {\DefaultWidthofCheckBox}
      \def\Fld@height{\DefaultHeightofCheckBox}
      \exp_args:No\HyField@SetKeys
        {
          \DefaultOptionsofCheckBox,#1
        }
      \PDFForm@Name
      \HyField@FlagsCheckBox
      \legacy_if:nT { Fld@hidden }
        {
          \def\Fld@width{1sp}
        }
      \LayoutCheckField{#2}
        {
          \mode_leave_vertical:
          \HyAnn@AbsPageLabel
          \Hy@escapeform\PDFForm@Check
          \pdf_annotation:nnnn
            {\Fld@width}
            {\Fld@height}
            {0pt} %is this correct?
            {\PDFForm@Check}
          \HyField@AddToFields %check if this works with xelatex ...
        }
    \group_end:
  }
\ExplSyntaxOff

%hm. Should a luatex driver use type1 fonts in fields????
\ExplSyntaxOn
\def\Hy@FormObjects
  {
    \pdf_object_new:nn   {l__hyp_encoding_pdfdoc_obj }   { dict }
    \pdf_object_new:nn   {l__hyp_font_zapfdingbats_obj } { dict }
    \pdf_object_new:nn   {l__hyp_font_helvetica_obj }    { dict }
    \pdf_object_write:nx {l__hyp_encoding_pdfdoc_obj }
      {
        /Type/Encoding
        /Differences[
          24/breve/caron/circumflex/dotaccent/hungarumlaut/ogonek
          /ring/tilde
          \c_space_tl
          39/quotesingle
          \c_space_tl
          96/grave %
          \iow_newline:
          128/bullet/dagger/daggerdbl/ellipsis/emdash/endash/florin
          /fraction/guilsinglleft/guilsinglright/minus/perthousand
          /quotedblbase/quotedblleft/quotedblright/quoteleft
          /quoteright/quotesinglbase/trademark/fi/fl/Lslash/OE
          /Scaron/Ydieresis/Zcaron/dotlessi/lslash/oe/scaron/zcaron
          \iow_newline:
          164/currency
          \c_space_tl
          166/brokenbar
          \c_space_tl
          168/dieresis/copyright/ordfeminine
          \c_space_tl
          172/logicalnot/.notdef/registered/macron/degree/plusminus
          /twosuperior/threesuperior/acute/mu
          \c_space_tl
          183/periodcentered/cedilla/onesuperior/ordmasculine
          \c_space_tl
          188/onequarter/onehalf/threequarters
          \iow_newline:
          192/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
          /Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave
          /Iacute/Icircumflex/Idieresis/Eth/Ntilde/Ograve/Oacute
          /Ocircumflex/Otilde/Odieresis/multiply/Oslash/Ugrave
          /Uacute/Ucircumflex/Udieresis/Yacute/Thorn/germandbls
          /agrave/aacute/acircumflex/atilde/adieresis/aring/ae
          /ccedilla/egrave/eacute/ecircumflex/edieresis/igrave
          /iacute/icircumflex/idieresis/eth/ntilde/ograve/oacute
          /ocircumflex/otilde/odieresis/divide/oslash/ugrave
          /uacute/ucircumflex/udieresis/yacute/thorn/ydieresis
         ]
      }
    \pdf_object_write:nn {l__hyp_font_zapfdingbats_obj }
      {
        /Type/Font
        /Subtype/Type1
        /Name/ZaDb
        /BaseFont/ZapfDingbats
      }
    \pdf_object_write:nx {l__hyp_font_helvetica_obj }
      {
        /Type/Font
        /Subtype/Type1
        /Name/Helv
        /BaseFont/Helvetica
        /Encoding~\pdf_object_ref:n { l__hyp_encoding_pdfdoc_obj }
      }
  \global\let\Hy@FormObjects\relax
  }
\ExplSyntaxOff
\providecommand*{\Fld@pageobjref}{}
\ifcsname pdf@escapestring\endcsname
  \def\Hy@escapeform#1{%
    \ifHy@pdfescapeform
      \let\Hy@escapestring\pdfescapestring
    \else
      \let\Hy@escapestring\@firstofone
    \fi
  }%
  \Hy@escapeform{}%
\else
  \let\Hy@escapestring\@firstofone
  \def\Hy@escapeform#1{%
    \ifHy@pdfescapeform
      \def\Hy@escapestring##1{%
        \noexpand\Hy@escapestring{\noexpand##1}%
      }%
      \edef\Hy@temp{#1}%
      \expandafter\Hy@@escapeform\Hy@temp\Hy@escapestring{}\@nil
      \def\Hy@escapestring##1{%
        \@ifundefined{Hy@esc@\string##1}{%
          ##1%
          \ThisShouldNotHappen
        }{%
          \csname Hy@esc@\string##1\endcsname
        }%
      }%
    \else
      \let\Hy@escapestring\@firstofone
    \fi
  }%
  \def\Hy@@escapeform#1\Hy@escapestring#2#3\@nil{%
    \ifx\\#3\\%
    \else
      \expandafter
      \Hy@pstringdef\csname Hy@esc@\string#2\endcsname{#2}%
      \ltx@ReturnAfterFi{%
        \Hy@@escapeform#3\@nil
      }%
    \fi
  }%
\fi
\def\PDFForm@Name{%
  \PDFForm@@Name\Fld@name
  \ifx\Fld@altname\relax
  \else
    \PDFForm@@Name\Fld@altname
  \fi
  \ifx\Fld@mappingname\relax
  \else
    \PDFForm@@Name\Fld@mappingname
  \fi
}
\def\PDFForm@@Name#1{%
  \begingroup
    \ifnum\Hy@pdfversion<5 % implementation note 117, PDF spec 1.7
      \ifHy@unicode
        \Hy@unicodefalse
      \fi
    \fi
    \HyPsd@XeTeXBigCharstrue
    \pdfstringdef\Hy@gtemp#1%
  \endgroup
  \let#1\Hy@gtemp
}
\def\Fld@@additionalactions{%
  \ifx\Fld@keystroke@code\@empty
  \else
    /K<</S/JavaScript/JS(\Hy@escapestring{\Fld@keystroke@code})>>%
  \fi
  \ifx\Fld@format@code\@empty
  \else
    /F<</S/JavaScript/JS(\Hy@escapestring{\Fld@format@code})>>%
  \fi
  \ifx\Fld@validate@code\@empty
  \else
    /V<</S/JavaScript/JS(\Hy@escapestring{\Fld@validate@code})>>%
  \fi
  \ifx\Fld@calculate@code\@empty
  \else
    /C<</S/JavaScript/JS(\Hy@escapestring{\Fld@calculate@code})>>%
  \fi
  \ifx\Fld@onfocus@code\@empty
  \else
    /Fo<</S/JavaScript/JS(\Hy@escapestring{\Fld@onfocus@code})>>%
  \fi
  \ifx\Fld@onblur@code\@empty
  \else
    /Bl<</S/JavaScript/JS(\Hy@escapestring{\Fld@onblur@code})>>%
  \fi
  \ifx\Fld@onmousedown@code\@empty
  \else
    /D<</S/JavaScript/JS(\Hy@escapestring{\Fld@onmousedown@code})>>%
  \fi
  \ifx\Fld@onmouseup@code\@empty
  \else
    /U<</S/JavaScript/JS(\Hy@escapestring{\Fld@onmouseup@code})>>%
  \fi
  \ifx\Fld@onenter@code\@empty
  \else
    /E<</S/JavaScript/JS(\Hy@escapestring{\Fld@onenter@code})>>%
  \fi
  \ifx\Fld@onexit@code\@empty
  \else
    /X<</S/JavaScript/JS(\Hy@escapestring{\Fld@onexit@code})>>%
  \fi
}
\def\Fld@additionalactions{%
  \if-\Fld@@additionalactions-%
  \else
    \ifHy@pdfa
    \else
      /AA<<\Fld@@additionalactions>>%
    \fi
  \fi
}
\def\Fld@annotnames{%
  /T(\Fld@name)%
  \ifx\Fld@altname\relax
  \else
    /TU(\Fld@altname)%
  \fi
  \ifx\Fld@mappingname\relax
  \else
    /TM(\Fld@mappingname)%
  \fi
}
\ExplSyntaxOn
\def\PDFForm@Check
  {
    /Subtype/Widget
    ~\Fld@annotflags
    ~\Fld@pageobjref
    ~\Fld@annotnames
    /FT/Btn
   \Fld@flags
   /Q~\Fld@align
   /BS<</W~\Fld@borderwidth /S/\Fld@borderstyle>>
   /AP
     <<
      /N
        <<
          /Yes~\pdf_xform_ref:o{\l__hyp_CheckmarkYes_tl}
          /Off~\pdf_xform_ref:o{\l__hyp_CheckmarkOff_tl}
        >>
    >>
  /MK<<
    \int_compare:nNnF {\Fld@rotation}={0}
      {
        /R~\Fld@rotation
      }
    \tl_if_empty:NF\Fld@bordercolor
      {
        /BC[\Fld@bordercolor]
      }
    \tl_if_empty:NF\Fld@bcolor
      {
        /BG[\Fld@bcolor]
      }
    /CA(\Hy@escapestring{\Fld@cbsymbol})%
  >>
  /DA
    (
      /ZaDb~\strip@pt\Fld@charsize\c_space_tl Tf
      \tl_if_empty:NF \Fld@color
        {
          \c_space_tl \Fld@color
        }
    )
  /H/P
  \legacy_if:nTF {Fld@checked}
    {
      /V/Yes /AS/Yes
    }
    {
      /V/Off /AS/Off
    }
  \Fld@additionalactions
}
\ExplSyntaxOff
\ExplSyntaxOn
\legacy_if:nF { Hy@pdfa }
  {
   \def\PDFForm@Push
     {
       /Subtype/Widget
       ~\Fld@annotflags
       ~\Fld@pageobjref
       ~\Fld@annotnames
       /FT/Btn
       ~\Fld@flags
       /H/P
       /BS<</W~\Fld@borderwidth/S/\Fld@borderstyle>>
       \bool_if:nT
         {
           !\int_compare_p:nNn {\Fld@rotation} = {0}
          ||
           \tl_if_exist_p:N \Fld@bordercolor
         }
         {
           /MK
             <<
               \int_compare:nNnF {\Fld@rotation} = {0}
                 {
                   /R~\Fld@rotation
                 }
               \tl_if_exist:NT \Fld@bordercolor
                 {
                   /BC[\Fld@bordercolor]
                 }
             >>
          }
       /A<</S/JavaScript/JS(\Hy@escapestring{\Fld@onclick@code})>>
       \Fld@additionalactions
     }
  }
\ExplSyntaxOff
\def\PDFForm@List{%
  /Subtype/Widget%
  \Fld@annotflags
  \Fld@pageobjref
  \Fld@annotnames
  /FT/Ch%
  \Fld@flags
  /Q \Fld@align
  /BS<</W \Fld@borderwidth/S/\Fld@borderstyle>>%
  \ifcase0\ifnum\Fld@rotation=\z@   \else 1\fi
          \ifx\Fld@bordercolor\relax\else 1\fi
          \ifx\fld@bcolor\relax     \else 1\fi
          \space
  \else
    /MK<<%
      \ifnum\Fld@rotation=\z@
      \else
        /R \Fld@rotation
      \fi
      \ifx\Fld@bordercolor\relax
      \else
        /BC[\Fld@bordercolor]%
      \fi
      \ifx\Fld@bcolor\relax
      \else
        /BG[\Fld@bcolor]%
      \fi
    >>%
  \fi
  /DA(/Helv \strip@pt\Fld@charsize\space Tf%
      \ifx\Fld@color\@empty\else\space\Fld@color\fi)%
  \Fld@choices
  \Fld@additionalactions
}
\ExplSyntaxOn
\def\PDFForm@Radio
  {
    /Subtype/Widget
    ~\Fld@annotflags
    ~\Fld@pageobjref
    ~\Fld@annotnames
    /FT/Btn
   \Fld@flags
   /H/P
   /BS<</W~\Fld@borderwidth/S/\Fld@borderstyle>>
   /MK<<
    \ifnum\Fld@rotation=\z@
    \else
      /R~\Fld@rotation
    \fi
    \ifx\Fld@bordercolor\relax
    \else
      /BC[\Fld@bordercolor]%
    \fi
    \ifx\Fld@bcolor\relax
    \else
      /BG[\Fld@bcolor]%
    \fi
     /CA(\Hy@escapestring{\Fld@radiosymbol})%
    >>
    /DA(/ZaDb~\strip@pt\Fld@charsize\space Tf%
      \ifx\Fld@color\@empty\else\space\Fld@color\fi)%
   \ifx\Fld@default\@empty
    /V/Off%
    /DV/Off%
   \else
    /V/\Fld@default
    /DV/\Fld@default
   \fi
   \Fld@additionalactions
 }
\ExplSyntaxOff
\ExplSyntaxOn
% Does an appeareance dict make sense here?
\def\PDFForm@Text
  {
    /Subtype/Widget
    ~\Fld@annotflags
    ~\Fld@pageobjref
    ~\Fld@annotnames
    /FT/Tx
    ~\Fld@flags
    /Q~\Fld@align
    /BS<</W~\Fld@borderwidth\c_space_tl /S /\Fld@borderstyle>>
   \bool_if:nT
     {
        !\int_compare_p:nNn {\Fld@rotation} = {0}
       ||
        \tl_if_exist_p:N \Fld@bordercolor
       ||
        \tl_if_exist_p:N \Fld@bcolor
     }
     {
       /MK
         <<
           \int_compare:nNnF {\Fld@rotation} = {0}
             {
               /R~\Fld@rotation
             }
           \tl_if_exist:NT \Fld@bordercolor
             {
               /BC[\Fld@bordercolor]
             }
           \tl_if_exist:NT \Fld@bcolor
             {
               /BG[\Fld@bcolor]
             }
        >>
     }
   /DA
     (
       /Helv~\strip@pt\Fld@charsize\c_space_tl Tf
       \tl_if_empty:NF {\c_space_tl\Fld@color}
     )
   /DV(\Hy@escapestring{\Fld@default})
   /V(\Hy@escapestring{\Fld@value})
   ~\Fld@additionalactions
   \int_compare:nNnT { \Fld@maxlen}>{0}
     {
       /MaxLen~\Fld@maxlen
     }
  }
\ExplSyntaxOff

\def\PDFForm@Submit{%
  /Subtype/Widget%
  \Fld@annotflags
  \Fld@pageobjref
  \Fld@annotnames
  /FT/Btn%
  \Fld@flags
  /H/P%
  /BS<</W \Fld@borderwidth/S/\Fld@borderstyle>>%
  \ifcase0\ifnum\Fld@rotation=\z@   \else 1\fi
          \ifx\Fld@bordercolor\relax\else 1\fi
          \space
  \else
    /MK<<%
      \ifnum\Fld@rotation=\z@
      \else
        /R \Fld@rotation
      \fi
      \ifx\Fld@bordercolor\relax
      \else
        /BC[\Fld@bordercolor]%
      \fi
    >>%
  \fi
  /A<<%
    /S/SubmitForm%
    /F<<%
      /FS/URL%
      /F(\Hy@escapestring{\Form@action})%
    >>%
    \Fld@submitflags
  >>%
  \Fld@additionalactions
}
\ifHy@pdfa
\else
  \def\PDFForm@Reset{%
    /Subtype/Widget%
    \Fld@annotflags
    \Fld@pageobjref
    \Fld@annotnames
    /FT/Btn%
    \Fld@flags
    /H/P%
    /DA(/Helv \strip@pt\Fld@charsize\space Tf 0 0 1 rg)%
    \ifcase0\ifnum\Fld@rotation=\z@   \else 1\fi
            \ifx\Fld@bordercolor\relax\else 1\fi
            \space
    \else
      /MK<<%
        \ifnum\Fld@rotation=\z@
        \else
          /R \Fld@rotation
        \fi
        \ifx\Fld@bordercolor\relax
        \else
          /BC[\Fld@bordercolor]%
        \fi
      >>%
    \fi
    /BS<</W \Fld@borderwidth/S/\Fld@borderstyle>>%
    /A<</S/ResetForm>>%
    \Fld@additionalactions
  }%
\fi

% UF: removed Hy@writebookmark
%     \Hy@currentbookmarklevel{0}
%     \Hy@numberline
%     \@@writetorep
%     counter{bookmark@seq@number}
% removed \HyPsd@SanitizeForOutFile, not needed
% removed \currentpdfbookmark, defined by bookmark,
% should use \newcommand there
% removed \subpdfbookmark, defined by bookmark,
% should use \newcommand there
% removed \belowpdfbookmark, defined by bookmark,
% should use \newcommand there
% removed \pdfbookmark, defined by bookmark,
% \BOOKMARK
% \@BOOKMARK
%% \RequirePackage{rerunfilecheck}[2009/12/10]
%% removed \Hy@OutlineRerunCheck, unneeded with bookmark
%% removed \ReadBookmarks / unneeded with bookmark.
%% removed \Hy@OutlineName
%% removed \check@bm@number
%% removed \calc@bm@number

\ifHy@implicit
\else
  \expandafter\endinput
\fi
\newlength\Hy@SectionHShift
\def\Hy@SectionAnchorHref#1{%
  \ifx\protect\@typeset@protect
    \Hy@@SectionAnchor{#1}%
  \fi
}
\DeclareRobustCommand*{\Hy@@SectionAnchor}[1]{%
  \leavevmode
  \hbox to 0pt{%
    \kern-\Hy@SectionHShift
    \Hy@raisedlink{%
      \hyper@anchorstart{#1}\hyper@anchorend
    }%
    \hss
  }%
}
\let\H@old@ssect\@ssect
\def\@ssect#1#2#3#4#5{%
  \Hy@MakeCurrentHrefAuto{section*}%
  \setlength{\Hy@SectionHShift}{#1}%
  \begingroup
    \toks@{\H@old@ssect{#1}{#2}{#3}{#4}}%
    \toks\tw@\expandafter{%
      \expandafter\Hy@SectionAnchorHref\expandafter{\@currentHref}%
      #5%
    }%
  \edef\x{\endgroup
    \the\toks@{\the\toks\tw@}%
  }\x
}
\let\H@old@schapter\@schapter
\def\@schapter#1{%
  \begingroup
    \let\@mkboth\@gobbletwo
    \Hy@MakeCurrentHrefAuto{\Hy@chapapp*}%
    \Hy@raisedlink{%
      \hyper@anchorstart{\@currentHref}\hyper@anchorend
    }%
  \endgroup
  \H@old@schapter{#1}%
}
\ltx@IfUndefined{@chapter}{}{%
  \let\Hy@org@chapter\@chapter
  \def\@chapter{%
    \def\Hy@next{%
      \Hy@MakeCurrentHrefAuto{\Hy@chapapp*}%
      \Hy@raisedlink{%
        \hyper@anchorstart{\@currentHref}\hyper@anchorend
      }%
    }%
    \ifnum\c@secnumdepth>\m@ne
      \ltx@IfUndefined{if@mainmatter}%
      \iftrue{\csname if@mainmatter\endcsname}%
        \let\Hy@next\relax
      \fi
    \fi
    \Hy@next
    \Hy@org@chapter
  }%
}
\let\H@old@part\@part
\begingroup\expandafter\expandafter\expandafter\endgroup
\expandafter\ifx\csname chapter\endcsname\relax
  \let\Hy@secnum@part\z@
\else
  \let\Hy@secnum@part\m@ne
\fi
\def\@part{%
  \ifnum\Hy@secnum@part>\c@secnumdepth
    \phantomsection
  \fi
  \H@old@part
}
\let\H@old@spart\@spart
\def\@spart#1{%
  \Hy@MakeCurrentHrefAuto{part*}%
  \Hy@raisedlink{%
    \hyper@anchorstart{\@currentHref}\hyper@anchorend
  }%
  \H@old@spart{#1}%
}
\let\H@old@sect\@sect
\def\@sect#1#2#3#4#5#6[#7]#8{%
  \ifnum #2>\c@secnumdepth
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi
  {%
    \Hy@MakeCurrentHrefAuto{section*}%
    \setlength{\Hy@SectionHShift}{#3}%
    \begingroup
      \toks@{\H@old@sect{#1}{#2}{#3}{#4}{#5}{#6}[{#7}]}%
      \toks\tw@\expandafter{%
        \expandafter\Hy@SectionAnchorHref\expandafter{\@currentHref}%
        #8%
      }%
    \edef\x{\endgroup
      \the\toks@{\the\toks\tw@}%
    }\x
  }{%
    \H@old@sect{#1}{#2}{#3}{#4}{#5}{#6}[{#7}]{#8}%
  }%
}
\expandafter\def\csname Parent-4\endcsname{}
\expandafter\def\csname Parent-3\endcsname{}
\expandafter\def\csname Parent-2\endcsname{}
\expandafter\def\csname Parent-1\endcsname{}
\expandafter\def\csname Parent0\endcsname{}
\expandafter\def\csname Parent1\endcsname{}
\expandafter\def\csname Parent2\endcsname{}
\expandafter\def\csname Parent3\endcsname{}
\expandafter\def\csname Parent4\endcsname{}

%%
%% End of file `hluatex.def'.
\endinput
%%
%% End of file `hluatex.def'.
