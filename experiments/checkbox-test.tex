% !Mode:: "TeX:DE:UTF-8:Main"

\RequirePackage{pdfresources}
%adapted from https://chat.stackexchange.com/transcript/message/54421537#54421537
\documentclass{article}

\pagestyle{empty}

\usepackage{xparse}
\usepackage{l3pdf}

\usepackage[customdriver=hgeneric-experimental]{hyperref}

\ExplSyntaxOn

\pdf_uncompress:
\cs_generate_variant:Nn \pdf_xform_wd:n {e}
\cs_generate_variant:Nn \pdf_xform_ht:n {e}
\cs_generate_variant:Nn \pdf_xform_dp:n {e}
\cs_generate_variant:Nn \pdf_xform_ref:n{e}



\tl_new:N \g_dcp_normal_off_default_tl
\tl_new:N \g_dcp_normal_yes_default_tl

% ## initialise global variables
\tl_set:Nn \g_dcp_normal_off_default_tl
  {
    checkbox/Off/dflt
  }
\tl_set:Nn \g_dcp_normal_yes_default_tl
  {
    checkbox/Yes/dflt
  }
  
\NewDocumentCommand \setdefaultcheckboxoff { m }
  {
   \tl_set:Nn \g_dcp_normal_off_default_tl { #1 }
  }

\NewDocumentCommand \setdefaultcheckboxyes { m }
  {
    \tl_set:Nn \g_dcp_normal_yes_default_tl { #1 }
  }
  
    

\pdf_xform_new:nnn {checkbox/Yes/dflt}{}
  {
    \hbox_set:Nn \l_tmpa_box { $\times$ }
    \box_set_ht:Nn \l_tmpa_box { 0.8 \box_ht:N \strutbox }
    \box_set_dp:Nn \l_tmpa_box { 0.2 \box_ht:N \strutbox }
    \fboxsep 0pt
    \framebox
      [ \box_ht:N \strutbox ]
      { \box_use_drop:N \l_tmpa_box }  
  }
  
\pdf_xform_new:nnn {checkbox/Off/dflt}{}
  {
    \hbox_set:Nn \l_tmpa_box {  }
    \box_set_ht:Nn \l_tmpa_box { 0.8 \box_ht:N \strutbox }
    \box_set_dp:Nn \l_tmpa_box { 0.2 \box_ht:N \strutbox }
    \fboxsep 0pt
    \framebox
      [ \box_ht:N \strutbox ]
      { \box_use_drop:N \l_tmpa_box }
  }  
  
\NewDocumentCommand \newcheckboxappearance { m m  }  %#1=name, #2 = content
 {
   \pdf_xform_new:nnn {#1}{}{#1} 
 }
 
 
% ## local variables
\dim_new:N \l_dcp_field_ht_dim
\dim_new:N \l_dcp_field_wd_dim
\dim_new:N \l_dcp_field_dp_dim
\int_new:N \l_dcp_field_flags_int
  
% # l3keys set up

\tl_new:N \l_dcp_normal_off_tl
\tl_new:N \l_dcp_normal_yes_tl

\keys_define:nn { dcp }
  {
    normal ~ off .tl_set_x:N = \l_dcp_normal_off_tl,
    normal ~ off .value_required:n = true,
    normal ~ yes .tl_set_x:N = \l_dcp_normal_yes_tl,
    normal ~ yes .value_required:n = true,
  }

\cs_new_protected:Nn \dcp_normalise_boxes:
  { 
    \dim_set:Nn \l_dcp_field_wd_dim
       { \dim_max:nn { \pdf_xform_wd:e {\l_dcp_normal_off_tl} }{ \pdf_xform_wd:e {\l_dcp_normal_yes_tl} } }
    \dim_set:Nn \l_dcp_field_ht_dim
      { \dim_max:nn { \pdf_xform_ht:e {\l_dcp_normal_off_tl} }{ \pdf_xform_ht:e {\l_dcp_normal_yes_tl} } }            
    \dim_set:Nn \l_dcp_field_dp_dim
      { \dim_max:nn { \pdf_xform_dp:e {\l_dcp_normal_off_tl} }{ \pdf_xform_dp:e {\l_dcp_normal_yes_tl} } }
  }



% # form and field interface macros

\NewDocumentCommand \checkboxfield { O{}m }
  {
    \group_begin:
    \keys_set:nn { dcp }
      {
        normal ~ yes = \g_dcp_normal_yes_default_tl,
        normal ~ off = \g_dcp_normal_off_default_tl,
        #1
      }
    \dcp_normalise_boxes:
    \pdfdict_put:nnn {annot/Widget}{FT}{/Btn}
    \pdfdict_put:nnn {annot/Widget}{T}{(#2)} %should pass throught some excape
    \pdfdict_put:nnn {annot/Widget}{V}{/Off} %should be configurable
    \pdfdict_put:nnn {annot/Widget}{AS}{/Off} %should be configurable
    \pdfannot_flag_clear:nn {annot/Field}{Radio} %just in case
    \pdfannot_flag_clear:nn {annot/Field}{Pushbutton} %just in case
    \pdfannot_flag_set:nn {annot/Field}{NoExport}
    \pdfdict_put:nnx {annot/Widget}{F}{\pdfannot_flag_use:n{annot/Field}}
    % more flag configuration needed?
%/AP <</N <</Yes 6 0 R/Off 9 0 R>>>>
%/P 6 0 R/Q 0/BS<</W 1/S/S>>/AP<< /N <</Yes<<>>>> >> /MK<</BC[1 0 0]/BG[1 1 1]/CA(4)>>/DA(/ZaDb 10 Tf 0 0 0 rg)/H/P
     \pdfdict_put:nnx {annot/Widget}{Q}{0}
    
     \hbox_to_wd:nn
       { \l_dcp_field_wd_dim  }
       {
        \pdfannot_box:nnnnn
           {Widget}
           { \dim_use:N \l_dcp_field_wd_dim }
           { \dim_use:N \l_dcp_field_ht_dim }
           { \dim_use:N \l_dcp_field_dp_dim }
           {
            /AP ~
              <<
                /N ~
                  << /Yes ~ \pdf_xform_ref:e { \l_dcp_normal_yes_tl}
                     /Off ~ \pdf_xform_ref:e { \l_dcp_normal_off_tl}
                  >>
              >>
           }
         \hfill
        }
      \pdfdict_gput:nnx { Catalog / AcroForm } { Fields }{\pdfannot_box_last:}
      \group_end:
  }

\ExplSyntaxOff

\usepackage{tikz}
\usepackage[default]{sourcesanspro}

\begin{document}
%\begin{Form}
\ExplSyntaxOn
x\pdf_xform_use:n {checkbox/Yes/dflt}y
x\pdf_xform_use:n {checkbox/Off/dflt}y
\ExplSyntaxOff
Option 1: \checkboxfield{checkbox1}

Option 1: \checkboxfield{checkbox2}

Option 1: \checkboxfield{checkbox3}

Option 1: \checkboxfield{checkbox1}

Option 1: \checkboxfield{checkbox1}

%\CheckBox{A}\CheckBox{A}
%\end{Form}
\end{document}

Option 2: \checkboxfield[%
normal off = ☐,
normal yes = ☑]{checkbox2}

Option 3: \checkboxfield[%
normal off = {\tikz[baseline, inner sep=1pt]
\node[draw=magenta, text=white, anchor=base]
{\vrule width 8pt height 7pt depth 1pt };},
normal yes = {\tikz[baseline, inner sep=1pt]
\node[draw=magenta, text=cyan, anchor=base]
{\vrule width 8pt height 7pt depth 1pt };},
]{checkbox3}

\end{document}

Field dict
Ft     : /Btn /Tx /Ch /Sig
Parent : OR
Kids: array, other fields or annot/widget
T: partial fieldname (test string)
TU: alternate description (test string)
TM: mapping name
Ff: flags ->annot/Field
V: value            % not pushbutton
DV: default value   % not pushbutton
AA: Action dict ... -> see below
Opt: array of strings, connected to kids
     or for choices, choices
TI integer (lists)
I array Ch (complicated ...)

/DA ( 0 0 1 rg /Ti 12 Tf ) %text field
/MaxLen                    %text field

Lock dict (Sig)
SV dict (Sig)




Connected widget:
/AS default appearance from AP ( here/Yes or /Off)
% Appearance
%checkbox
/AP <</N <</Yes 2 0 R /Off 3 0 R>>>>
/C / Border /BS

/OC ?
/Structparens?
/F flags


AA: Submit:
  /S   /SubmitForm
  /F   file /URI (/F ( ftp : / / www . beatles . com / Movies / AbbeyRoad . mov )
  /Fields array

  /S /ImportData
  /F file

  /S /ResetData
  /Fields array

  /S /JavaScript
  /JS text string or stream