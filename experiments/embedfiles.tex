% !Mode:: "TeX:UTF-8:Main"
\documentclass{article}
\usepackage{pdfresources}
\usepackage{l3pdffile}
\usepackage{hyperref}
\ExplSyntaxOn
\pdf_uncompress:
\ExplSyntaxOff
\begin{document}
\section{Testing embedding and attaching files}
\ExplSyntaxOn
\showoutput
\cs_new_protected:Npn \__pdf_backend_object_write_fstream:nn #1#2
  {
    \exp_args:Nx
      \__pdf_backend_object_write_fstream:nnn {#1} #2
  }

\cs_new_protected:Npn \__pdf_backend_object_write_fstream:nnn #1#2#3
  {
   \tl_set:Nn\l_tmpa_tl {#3}\show\l_tmpa_tl

    \__kernel_backend_postscript:x
      {
        %[nobreak]
        ~
        mark ~ #1 ~ << #2 >> /PUT ~ pdfmark ~
        mark ~ #1 ~ ( #3 )~ (r)~ file ~ /PUT ~ pdfmark ~
      }
  }

%\%cs_set_protected:Npn \pdffile_embed:nn #1 #2
% % #1 symbolic object name of file spec  #2 file name,
%  {
%    \file_get_full_name:nNF {#2} \l_pdffile_full_name_str
%     {
%        \msg_error:nnn { pdffile }{ file-not-found }{ #2 }
%     }
%    %we need the extension
%    \file_parse_full_name:VNNN
%      \l_pdffile_full_name_str
%      \l_tmpa_tl
%      \l_tmpb_tl
%      \l__pdf_file_ext_str
%    %check if Subtype has been set
%    \pdfdict_get:nnN {file}{Subtype}\l__pdf_file_tmpa_tl
%    \quark_if_no_value:NT \l__pdf_file_tmpa_tl
%      {
%        \prop_get:NVNTF \g_pdffile_mimetypes_prop \l__pdf_file_ext_str \l_tmpa_tl
%          {
%            \tl_set:Nx \l__pdf_file_subtype_tl {/Subtype~\pdftool_name:V \l_tmpa_tl}
%           }
%          {
%            \tl_clear:N \l__pdf_file_subtype_tl
%            \msg_warn:nnn { pdffile }{ mimetype-missing} { #2 }
%          }
%      }
%    \pdf_object_now:nx { fstream }
%      {
%        {
%          \l__pdf_file_subtype_tl
%          \pdfdict_map:n {file}
%          \pdfdict_if_empty:nF {file/Params}
%            {
%              /Params
%                <<
%                  \pdfdict_map:n {file/Params}
%                >>
%            }
%        }
%        { \l_pdffile_full_name_str }
%      }
%%    \tl_clear:N \l__pdf_file_subtype_tl
%%    \tl_set:Nx  \l__pdf_file_object_last_tl {\pdf_object_last:}
%%    \pdf_object_new:nn   { #1 } {dict}
%%    \pdf_object_write:nx { #1 }
%%      {
%%        \pdfdict_map:n {file/FileSpec}
%%        /EF <</F~\l__pdf_file_object_last_tl /UF~\l__pdf_file_object_last_tl>>
%%      }
%  }

\pdfdict_put:nnn  {file/FileSpec} {AFRelationship}{/Source}
\pdfdict_put:nnn  {file/FileSpec} {Desc}{(this~is~a~eps)}
\pdffile_embed:nn {example}{example-imageX.eps}
\pdffile_attach:n {example}
%
\pdfdict_put:nnn  {file/FileSpec} {AFRelationship}{/Data}
\pdfdict_put:nnn  {file/FileSpec} {Desc}{(this~is~a~text~file)}
\pdffile_embed:nn {test} {testinput.txt}
\pdffile_attach:n {test}
%
\pdfdict_put:nnn  {file/FileSpec} {AFRelationship}{/Source}
\pdfdict_put:nnn  {file/FileSpec} {Desc}{(this~is~a~tex~file)}
\pdffile_embed:nn {tex} {links.tex}
\pdffile_attach:nN {tex}\l_tmpa_tl

%\tl_show:N\l_tmpa_tl
\ExplSyntaxOff

\end{document}
%\pdf_object_new:nn  {myfilespec}{dict}
%\pdf_object_write:nx {myfilespec}
% {
%  /Type /Filespec
%  /F (example-image.eps)
%  /UF (example-image.eps)
%  /AFRelationship /Source
%  /EF <</F~\l_tmpa_tl >>
%  /Desc (this~is~a~description)
% }
%
%\pdf_object_new:nn  {myfilespec2}{dict}
%\pdf_object_write:nx {myfilespec2}
% {
%  /Type /Filespec
%  /F (ftestinput.txt)
%  /UF (blubltestinput.txt)
%  /AFRelationship /Source
%  /EF <</F~\l_tmpa_tl >>
% }
%

\pdf_object_new:nn {embedfilelist}{dict}
\pdf_object_write:nx {embedfilelist}
 {
  /Names[ \seq_use:Nn \g__pdf_file_embednames_seq {~}]
 }

\bool_if:nT {\sys_if_engine_pdftex_p: && \sys_if_output_pdf_p:}
 {
  \pdfnames{/EmbeddedFiles~\pdf_object_ref:n{embedfilelist} }
 }

\sys_if_engine_luatex:T
 {
   \pdfextension names {/EmbeddedFiles~\pdf_object_ref:n{embedfilelist} }
 }

\sys_if_engine_xetex:T
 {
  \special{pdf: put @names <</EmbeddedFiles~\pdf_object_ref:n{embedfilelist}>>}
 }

\bool_if:nT {\sys_if_engine_pdftex_p: && !\sys_if_output_pdf_p:}
 {
  %\pdfnames{/EmbeddedFiles~\pdf_object_ref:n{embedfilelist} }
  %[/Name (Unicode Name)
%/FS << /Type /Filespec /F (name) /EF << /F {streamName} >> >>
%EMBED pdfmark
   \__pdf_backend_pdfmark:x
     {
       /Name~ (e22)~
       /FS~\pdf_object_ref:n{myfilespec}
       ~ /EMBED
   }
   \__pdf_backend_pdfmark:x
     {
       /Name~ (e3)~
       /FS~\pdf_object_ref:n{myfilespec2}
       ~ /EMBED
   }
  }



\ExplSyntaxOff
\end{document}

immediate\pdfobj{%
          <<%
            /Names[\EmFi@list]%
          >>%
        }%
        \pdfnames{%
          /EmbeddedFiles \the\pdflastobj\ltx@space 0 R%
        }%