\ProvidesExplPackage {new-pdfescape} {2020-04-21} {0.1}
  {temporary escape commands and tools for PDF}
%very temporarly until this is in l3 properly!!!!

\cs_generate_variant:Nn \str_convert_pdfname:n { e }

%% tool command escape name
%% commands in the argument are expanded if possible
%% with \text_expand:n
%% name: only name,
%% name_print: with / before, see also string naming
 \cs_new:Npn \pdftool_name:n #1
    { \str_convert_pdfname:e { \text_expand:n{#1} } }

\cs_generate_variant:Nn \pdftool_name:n {V}

 \cs_new:Npn \pdftool_name_print:n #1
    { / \str_convert_pdfname:e { \text_expand:n{#1} } }

\cs_generate_variant:Nn \pdftool_name_print:n {V}


%% string conversions and printing
%% we assume here that the text purify step has been done. The input is
%% a list of (utf8) chars.
%% str convert, not expandable.
%  filespec (attachment view)  tests:
%  utf8:  gr\303\274\303\237e.txt                    %doesn't work, umlaut wrong,
%  utf8 with BOM \357\273\277gr\303\274\303\237e.txt %doesn't work, umlaut wrong, bom visible
%  utf16 with BE: (FEFF)  \376\377\000g\000r\000\374\000\337\000e\000.\000t\000x\000t %works
%                xetex converts to <feff0067007200fc00df0065002e007400780074>
%  utf16 with BE / HEX: <FEFF0067007200FC00DF0065002E007400780074> works

% bookmarks: as pdfoutline uses () currently only utf16 with BE is usable.
% check if one can use HEX too when directly writing the object

% "input" is utf8 for pdftex, empty (native) for unicode engine
% commands to output literal strings  (...)
\sys_if_engine_pdftex:TF
  {
    \cs_new:Npn \pdftool_textstringlit:nN #1 #2
      {
         \str_set_convert:Nnnn #2 { #1 }{ utf8 } {utf16/string}
      }

    \cs_new:Npn \pdftool_textstringlit_print:nN #1 #2
      {
         \str_set_convert:Nnnn #2 { #1 }{ utf8 } {utf16/string}
         \str_put_left:Nn #2  {(}
         \str_put_right:Nn #2 {)}
      }
  }
  {
     \cs_new:Npn \pdftool_textstringlit:nN #1 #2
      {
        \str_set_convert:Nnnn #2 { #1 }{  } {utf16/string}
      }

    \cs_new:Npn \pdftool_textstringlit_print:nN #1 #2
      {
        \str_set_convert:Nnnn #2 { #1 }{  } {utf16/string}
        \str_put_left:Nn #2  {(}
        \str_put_right:Nn #2 {)}
      }
  }

% commands to output hex strings  (...)

\sys_if_engine_pdftex:TF
  {
    \cs_new:Npn \pdftool_textstringhex:nN #1 #2
      {
         \str_set_convert:Nnnn #2 { #1 }{ utf8 } {utf16/hex}
      }
    \cs_new:Npn \pdftool_textstringhex_print:nN #1 #2
      {
         \str_set_convert:Nnnn #2 { #1 }{ utf8 } {utf16/hex}
         \str_put_left:Nn #2  {<}
         \str_put_right:Nn #2 {>}
      }
  }
  {
    \cs_new:Npn \pdftool_textstringhex:nN #1 #2
      {
        \str_set_convert:Nnnn #2 { #1 }{  } {utf16/hex}
      }

    \cs_new:Npn \pdftool_textstringhex_print:nN #1 #2
      {
        \str_set_convert:Nnnn #2 { #1 }{  } {utf16/hex}
         \str_put_left:Nn #2  {<}
         \str_put_right:Nn #2 {>}
      }
  }

\cs_generate_variant:Nn \pdftool_textstringhex_print:nN {VN}
\cs_generate_variant:Nn \pdftool_textstringhex:nN       {VN}
\cs_generate_variant:Nn \pdftool_textstringlit_print:nN {VN}
\cs_generate_variant:Nn \pdftool_textstringlit:nN       {VN}
