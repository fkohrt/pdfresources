%%
%% This is file `new-transparent.sty',
%% base on transparent sty from Heiko Oberdiek
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{new-transparent}%
  {2020-09-06}{v1.42}{Transparency with color stacks (based on transparent from Heiko Oberdiek)}%
%pdftex + luatex in pdf mode
\sys_if_output_pdf:T
  {
    \bool_lazy_and:nnF {\bool_if_exist_p:N \g__pdf_Core_active_bool } { \g__pdf_Core_active_bool }
      {
        \PackageWarningNoLine{new-transparent}
         {
           Loading~aborted,~because~pdf~resource~management~code~not~found~%
           or~not~active
         }
        \endinput
      }
   }
\sys_if_engine_pdftex:T
  {
    \let\TRP@pdfcolorstackinit\tex_pdfcolorstackinit:D
    \let\TRP@pdfcolorstack\tex_pdfcolorstack:D
  }

\sys_if_engine_luatex:T
  {
    \def\TRP@pdfcolorstackinit           {\pdffeedback~colorstackinit}
    \protected\def\TRP@pdfcolorstack     {\pdfextension~colorstack}
  }

\sys_if_output_pdf:T
  {
    %initialize opacity 1
    \pdfcoredict_gput:nnn{Page/Resources/ExtGState}{TRP1}{<</ca~1/CA~1>>}
    %
    \cs_new_protected:Npn \__transparent_use:n #1
      {
        \tl_if_exist:cF { c__transparent_TRP#1_tl }
          {
            \pdfcoredict_gput:nnn{Page/Resources/ExtGState}{TRP#1}{<</ca~#1/CA~#1>>}
            \tl_const:cn { c__transparent_TRP#1_tl }{ /TRP#1~gs }
          }
      }
    \xdef\TRP@colorstack{%
         \TRP@pdfcolorstackinit~page~direct{/TRP1~gs}}
    \NewDocumentCommand{\transparent} { m }
      {
        \exp_args:Nx\__transparent_use:n { \fp_eval:n{ min(max(0,#1),1)}}
        \tl_set:Nx  \transparent@current { \fp_eval:n{ min(max(0,#1),1)}}
        \transparent@set
      }

    \def\transparent@current{/TRP1~gs}
    \def\transparent@set
      {
        \TRP@pdfcolorstack\TRP@colorstack~push~
          {
            \tl_use:c { c__transparent_TRP\transparent@current _tl }
          }
            \aftergroup\transparent@reset
      }

    \def\transparent@reset{\TRP@pdfcolorstack\TRP@colorstack~pop\relax}

  }

%xetex, dvipdfmx
\str_case_e:nnT {\g__sys_backend_tl}
 {
   {xetex}{}
   {dvipdfmx}{}
 }
 {
   \PackageInfo{new-transparent}{xetex~and~dvipdfmx~need~dvipdfmx~newer~than~20200901}{}
   \NewDocumentCommand{\transparent} { m }
      {
       \transparent@set{#1}
      }
   \def\transparent@set #1
      {
        \special{pdf:bxgstate~<</CA~#1/ca~#1>>}
        \aftergroup\transparent@reset
      }

    \def\transparent@reset{\special{pdf:exgstate}}
 }

%warning for dvips currently missing
% but it should at least not error
\ProvideDocumentCommand\transparent { m }{}

\NewDocumentCommand{\texttransparent}{m m}
  {
   \protect\leavevmode
   \begingroup
     \transparent{#1}
     #2
   \endgroup
  }


\endinput
%%
%% End of file `new-transparent.sty'.
